<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CBSaúde Cooperados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --azul: #2563eb;
            --azul-escuro: #1e40af;
            --azul-claro: #eff6ff;
            --branco: #ffffff;
            --cinza: #f8fafc;
            --texto: #1e293b;
            --texto-suave: #64748b;
            --borda: #e2e8f0;
            --erro: #ef4444;
            --sucesso: #22c55e;
            --aviso: #f59e0b;
            --transicao: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sombra-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sombra-inset: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            --sombra-foco: 0 0 0 3px rgba(37, 99, 235, 0.25);
            --gradient-bg: linear-gradient(135deg, var(--azul-claro), var(--branco));
        }
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Roboto, sans-serif;
        }
        body {
            margin: 0;
            background: var(--gradient-bg);
            color: var(--texto);
            font-size: clamp(14px, 2.5vw, 16px);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            transition: background var(--transicao);
        }
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(145deg, var(--azul-claro), var(--branco));
            box-shadow: var(--sombra);
            padding: .6rem .8rem;
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.5s ease-out;
        }
        .top-bar h1 {
            margin: 0;
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: var(--azul-escuro);
            text-shadow: 1px 1px 2px rgba(0,0,0,.1);
            transition: color var(--transicao);
        }
        .top-bar h1:hover {
            color: var(--azul);
        }
        .btn-top {
            background: var(--azul);
            color: #fff;
            border: none;
            padding: .7rem 1.2rem;
            border-radius: 8px;
            box-shadow: var(--sombra);
            cursor: pointer;
            transition: all var(--transicao);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .btn-top:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--sombra-hover);
            background: var(--azul-escuro);
        }
        
        .btn-top:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--sombra);
        }
        
        .btn-top::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease-in-out;
        }
        
        .btn-top:hover::after {
            transform: translateX(100%);
        }
        .btn-top.imprimir {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }
        .btn-top.sair {
            background: linear-gradient(145deg, #c62828, #8e0000);
            margin-left: auto;
        }
        .tabs-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            background: var(--branco);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
        }
        .tabs {
            display: flex;
            gap: .3rem;
            min-width: max-content;
            transition: all var(--transicao);
        }
        .tab {
            padding: .6rem 1rem;
            background: linear-gradient(145deg, var(--branco), var(--azul-claro));
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            box-shadow: var(--sombra-inset);
            white-space: nowrap;
            transition: all var(--transicao);
        }
        .tab:hover {
            transform: translateY(-2px);
            background: var(--azul-claro);
        }
        .tab.active {
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            transform: translateY(0);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: .8rem;
            animation: fadeIn 0.6s ease-in-out;
        }
        .card {
            background: var(--branco);
            border-radius: 12px;
            box-shadow: var(--sombra);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: scaleIn 0.4s ease-out;
            transition: all var(--transicao);
        }
        
        .card:hover {
            box-shadow: var(--sombra-hover);
            transform: translateY(-4px) scale(1.01);
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: .8rem;
            transition: all var(--transicao);
        }
        .col {
            flex: 1 1 260px;
            display: flex;
            flex-direction: column;
            transition: transform var(--transicao);
        }
        .col:hover {
            transform: translateY(-2px);
        }
        label {
            margin-bottom: .3rem;
            font-weight: 600;
            color: var(--azul-escuro);
            transition: color var(--transicao);
        }
        input, select, textarea {
            width: 100%;
            padding: .7rem .8rem;
            font-size: 1em;
            color: var(--texto);
            background: var(--branco);
            border: 1px solid var(--borda);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
            transition: all var(--transicao);
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: var(--azul);
            transform: scale(1.02);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--azul);
            box-shadow: var(--sombra-foco);
            transform: scale(1.02);
        }
        
        input:disabled, select:disabled, textarea:disabled {
            background: var(--cinza);
            cursor: not-allowed;
            opacity: 0.7;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .hidden {
            display: none;
        }
        .tabContent {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            transition: opacity var(--transicao), transform var(--transicao);
        }
        .tabContent.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
                filter: blur(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding: 4vh 1rem;
            z-index: 200;
            animation: fadeIn 0.3s;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--branco);
            border-radius: 10px;
            box-shadow: var(--sombra-hover);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: scaleIn 0.4s ease-out;
        }
        .modal-header {
            padding: .8rem 1rem;
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .search-input {
            width: 100%;
            padding: .7rem;
            font-size: 1.1em;
            border: 2px solid var(--azul-claro);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all var(--transicao);
        }
        .search-input:focus {
            border-color: var(--azul);
            transform: scale(1.02);
        }
        .list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--borda);
            cursor: pointer;
            transition: all var(--transicao);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--branco);
            box-shadow: var(--sombra);
        }
        
        .list-item:hover {
            background: var(--azul-claro);
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--sombra-hover);
        }
        
        .list-item:active {
            transform: translateY(2px) scale(0.98);
        }
        .list-item span {
            display: block;
            font-weight: 600;
        }
        .list-item small {
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .95em;
        }
        th, td {
            padding: .6rem .5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: var(--azul-claro);
            color: var(--azul-escuro);
        }
        tr:hover {
            background: #f1f8ff;
            transition: background var(--transicao);
        }
        .actions {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: .4rem .6rem;
            font-size: .85em;
        }
        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333) !important;
        }
        .resumo-block {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            animation: fadeIn 0.5s;
        }
        .resumo-line {
            display: flex;
            justify-content: space-between;
            padding: .5rem 0;
            border-bottom: 1px dotted #ddd;
            transition: background var(--transicao);
        }
        .resumo-line:hover {
            background: var(--azul-claro);
        }
        .total {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid var(--azul);
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            color: var(--azul-escuro);
            animation: scaleIn 0.4s;
        }
        .fade-out {
            animation: fadeOut .4s forwards;
        }
        @keyframes fadeOut {
            to { 
                opacity: 0; 
                transform: translateY(30px);
                filter: blur(5px);
            }
        }

        .notificacao {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            box-shadow: var(--sombra-hover);
            z-index: 1000;
            min-width: 200px;
            text-align: center;
            animation: slideIn 0.4s ease-out, fadeOut 0.4s 2.6s forwards;
        }

        .notificacao.sucesso {
            background: var(--sucesso);
        }

        .notificacao.erro {
            background: var(--erro);
        }

        .notificacao.info {
            background: var(--azul);
        }

        .notificacao.aviso {
            background: var(--aviso);
        }
    </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<section id="loginScreen" class="container login-box">
    <div class="card" style="max-width:400px;margin:10vh auto; animation: scaleIn 0.6s ease-out;">
        <h2>CBSaúde - Login</h2>
        <label>Usuário</label>
        <input id="userInput" type="text" placeholder="admin">
        <label>Senha</label>
        <input id="passInput" type="password" placeholder="1234">
        <button class="btn-top" onclick="doLogin()">Entrar</button>
        <p style="color:#666;font-size:.8rem;margin-top:.8rem;">Login master: admin / 1234</p>
    </div>
</section>

<!-- ÁREA PRINCIPAL -->
<section id="mainApp" class="hidden">
    <!-- TOPO COM BOTÕES -->
    <div class="top-bar">
        <h1>CBSaúde Cooperados</h1>
        <button class="btn-top" onclick="abrirPesquisa()">Procurar</button>
        <button class="btn-top" onclick="alterar()">Alterar</button>
        <button class="btn-top" onclick="gravar()">Gravar</button>
        <button class="btn-top" onclick="novo()">Novo</button>
        <button class="btn-top imprimir" onclick="imprimirPDF()">PDF</button>
        <button class="btn-top hidden" onclick="abrirResumoGeral()" id="btnResumoGeral">Resumo Geral</button>
        <button class="btn-top hidden" onclick="abrirGerenciaFuncionarios()" id="btnGerencia">Gerenciar Funcionários</button>
        <button class="btn-top sair" onclick="doLogout()">Sair</button>
    </div>

    <div class="container">
        <div class="card">
            <form id="associadoForm" onsubmit="saveAll(event)">
                <input id="editIndex" type="hidden">

                <!-- ABAS RESPONSIVAS -->
                <div class="tabs-wrapper">
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('dados')">Dados Pessoais</div>
                        <div class="tab" onclick="switchTab('dependentes')">Dependentes</div>
                        <div class="tab" onclick="switchTab('conjuge')">Cônjuge</div>
                        <div class="tab" onclick="switchTab('resumo')">Resumo Individual</div>
                    </div>
                </div>

                <!-- CONTEÚDO DAS ABAS -->
                <div id="dados" class="tabContent active">
                    <h3>Dados Pessoais</h3>
                    <div class="row">
                        <div class="col"><label>Nome *</label><input id="nome" required></div>
                        <div class="col"><label>CPF *</label><input id="cpf" required></div>
                        <div class="col"><label>Nº da Pasta</label><input id="pasta"></div>
                        <div class="col"><label>Matrícula</label><input id="matricula"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Data Nasc.</label><input id="nasc" type="date"></div>
                        <div class="col"><label>Data de Associação</label><input id="dataAssociacao" type="date"></div>
                        <div class="col"><label>Sexo</label>
                            <select id="sexo">
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Não-binário</option>
                                <option>Trans</option>
                            </select>
                        </div>
                        <div class="col"><label>Estado Civil</label>
                            <select id="civil">
                                <option>Solteiro(a)</option><option>Casado(a)</option><option>Divorciado(a)</option><option>Viúvo(a)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Endereço</label><input id="endereco"></div>
                        <div class="col"><label>Número</label><input id="numero"></div>
                        <div class="col"><label>Bairro</label><input id="bairro"></div>
                        <div class="col"><label>Município</label><input id="municipio"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Estado</label><input id="estado" maxlength="2"></div>
                        <div class="col"><label>CEP</label><input id="cep"></div>
                        <div class="col"><label>Telefone</label><input id="telefone"></div>
                        <div class="col"><label>E-mail</label><input id="email" type="email"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Plano</label>
                            <select id="plano">
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Observações</label><textarea id="obs"></textarea></div>
                    </div>
                    <small>* Campos obrigatórios apenas para o titular. Dependentes e cônjuge podem ser salvos parcialmente.</small>
                </div>

                <div id="dependentes" class="tabContent">
                    <h3>Dependentes</h3>
                    <div id="depsList"></div>
                    <button type="button" class="btn-top" onclick="addDependente()">+ Dependente</button>
                </div>

                <div id="conjuge" class="tabContent">
                    <h3>Cônjuge</h3>
                    <div class="row">
                        <div class="col"><label>Nome</label><input id="conjNome"></div>
                        <div class="col"><label>CPF</label><input id="conjCpf"></div>
                        <div class="col"><label>Data Nasc.</label><input id="conjNasc" type="date"></div>
                        <div class="col"><label>Plano</label>
                            <select id="conjPlano">
                                <option value="">Nenhum</option>
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="resumo" class="tabContent">
                    <h3>Resumo Individual</h3>
                    <div id="resumoContent"></div>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- MODAL PESQUISA -->
<div id="modalPesquisa" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Pesquisar Cooperado</span>
            <button class="btn-top" onclick="fecharPesquisa()">✖</button>
        </div>
        <div class="modal-body">
            <input class="search-input" id="searchModalInput" placeholder="Digite nome ou CPF..." onkeyup="debouncedFilter()">
            <div id="modalResults"></div>
        </div>
    </div>
</div>

<!-- MODAL GERENCIAR FUNCIONÁRIOS (só admin) -->
<div id="modalFuncionarios" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Gerenciar Funcionários</span>
            <button class="btn-top" onclick="fecharGerenciaFuncionarios()">✖</button>
        </div>
        <div class="modal-body">
            <h4>Adicionar Funcionário</h4>
            <div class="row">
                <div class="col"><label>Nome</label><input id="funcNome"></div>
                <div class="col"><label>Usuário</label><input id="funcUser"></div>
                <div class="col"><label>Senha</label><input id="funcPass" type="password"></div>
            </div>
            <button class="btn-top" onclick="adicionarFuncionario()">Adicionar</button>
            <hr>
            <h4>Funcionários Cadastrados</h4>
            <div id="listaFuncionarios"></div>
        </div>
    </div>
</div>

<!-- MODAL RESUMO GERAL (só admin) -->
<div id="modalResumoGeral" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Resumo Geral</span>
            <button class="btn-top" onclick="fecharResumoGeral()">✖</button>
        </div>
        <div class="modal-body">
            <div id="resumoGeralContent"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBexxAzdyVtthakeOVfTf-PxnlQ5rNynRQ",
        authDomain: "cbsaudecooperados.firebaseapp.com",
        projectId: "cbsaudecooperados",
        storageBucket: "cbsaudecooperados.firebasestorage.app",
        messagingSenderId: "558244165893",
        appId: "1:558244165893:web:2e10e9560c896f43e6df6c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- FUNÇÕES UTILITÁRIAS ----------
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatarTelefone(tel) {
        tel = tel.replace(/\D/g, '');
        if (tel.length === 11) {
            return tel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
        return tel.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }

    function formatarCEP(cep) {
        cep = cep.replace(/\D/g, '');
        return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }

    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
            return false;
        }
        
        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        
        let resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(9))) return false;
        
        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(10))) return false;
        
        return true;
    }

    async function getData() {
        try {
            const q = query(collection(db, 'associados'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function getFuncionarios() {
        try {
            const q = query(collection(db, 'funcionarios'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    // ---------- FUNÇÕES GLOBAIS (BOTÕES E NAVEGAÇÃO) ----------
    // Sistema de notificções
    function mostrarNotificacao(mensagem, tipo = 'info') {
        const div = document.createElement('div');
        div.className = `notificacao ${tipo} animate-slide-in`;
        div.textContent = mensagem;
        document.body.appendChild(div);
        
        setTimeout(() => {
            div.classList.add('fade-out');
            setTimeout(() => div.remove(), 400);
        }, 3000);
    }

    // Debounce para busca
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    let filtrarModal = null;
    let debouncedFilter = null;
    async function _filtrarModal() {
        const term = removerAcentos(document.getElementById('searchModalInput').value.toLowerCase());
        const lista = await getData();
        const div = document.getElementById('modalResults');
        div.innerHTML = '';
        lista
            .filter(a => {
                const nome = removerAcentos(a.nome.toLowerCase());
                const cpf = a.cpf.replace(/\D/g, '');
                return nome.includes(term) || cpf.includes(term.replace(/\D/g, ''));
            })
            .forEach(a => {
                const removeBtn = window.usuarioLogado?.admin ? `<button class="btn-top btn-danger btn-small" onclick="removerCooperado('${a.id}', event)">Remover</button>` : '';
                div.insertAdjacentHTML('beforeend', `
                    <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
                        <div onclick="editAssociado('${a.id}')">
                            <span>${escapeHTML(a.nome)}</span>
                            <small>CPF: ${a.cpf || '—'} | Nº da Pasta: ${a.pasta || '—'}</small>
                        </div>
                        ${removeBtn}
                    </div>
                `);
            });
        if (!div.innerHTML) div.innerHTML = '<p>Nenhum resultado.</p>';
    }

    filtrarModal = _filtrarModal;
    debouncedFilter = debounce(filtrarModal, 300);

    async function doLogin() {
        const btnLogin = document.querySelector('button[onclick="doLogin()"]');
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        
        if (!u || !p) {
            mostrarNotificacao('Preencha todos os campos', 'erro');
            return;
        }

        btnLogin.disabled = true;
        btnLogin.textContent = 'Entrando...';
        
        setTimeout(async () => {
            const funcs = await getFuncionarios();
            const user = funcs.find(f => f.user === u && f.pass === p);
            
            if (user) {
                window.usuarioLogado = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                if (user.admin) {
                    document.getElementById('btnGerencia').classList.remove('hidden');
                    document.getElementById('btnResumoGeral').classList.remove('hidden');
                }
                mostrarNotificacao(`Bem-vindo, ${user.nome}!`, 'sucesso');
            } else {
                mostrarNotificacao('Usuário ou senha inválidos', 'erro');
                document.getElementById('passInput').value = '';
                document.getElementById('passInput').focus();
            }
            
            btnLogin.disabled = false;
            btnLogin.textContent = 'Entrar';
        }, 800);
    }

    function doLogout() {
        if (confirm('Deseja realmente sair?')) {
            window.usuarioLogado = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('userInput').value = '';
            document.getElementById('passInput').value = '';
            document.getElementById('btnGerencia').classList.add('hidden');
            document.getElementById('btnResumoGeral').classList.add('hidden');
        }
    }

    function abrirPesquisa() {
        document.getElementById('modalPesquisa').classList.add('active');
        document.getElementById('searchModalInput').value = '';
        filtrarModal();
        document.getElementById('searchModalInput').focus();
    }

    function fecharPesquisa() {
        document.getElementById('modalPesquisa').classList.remove('active');
    }

    function novo() {
        resetAll();
        switchTab('dados');
    }

    async function gravar() {
        await saveAll(new Event('submit'));
    }

    function alterar() {
        abrirPesquisa();
    }

    async function imprimirPDF() {
        await buildResumo();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const conteudo = document.getElementById('resumoContent').innerText;
        doc.setFontSize(16);
        doc.text('CBSaúde Cooperados - Resumo Individual', 14, 22);
        doc.setFontSize(12);
        const linhas = conteudo.split('\n');
        linhas.forEach((linha, i) => doc.text(linha, 14, 40 + i * 6));
        doc.save('resumo-individual-cbsaude.pdf');
    }

    async function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tabContent').forEach(c => c.classList.remove('active'));
        document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(tab).classList.add('active');
        if (tab === 'resumo') await buildResumo();
    }

    async function abrirGerenciaFuncionarios() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado. Apenas administradores podem gerenciar funcionários.', 'erro');
            return;
        }
        document.getElementById('modalFuncionarios').classList.add('active');
        await renderizarFuncionarios();
    }

    function fecharGerenciaFuncionarios() {
        document.getElementById('modalFuncionarios').classList.remove('active');
    }

    async function adicionarFuncionario() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        const nome = document.getElementById('funcNome').value.trim();
        const user = document.getElementById('funcUser').value.trim();
        const pass = document.getElementById('funcPass').value.trim();
        if (!nome || !user || !pass) {
            mostrarNotificacao('Preencha todos os campos.', 'erro');
            return;
        }
        const funcs = await getFuncionarios();
        if (funcs.find(f => f.user === user)) {
            mostrarNotificacao('Usuário já existe.', 'erro');
            return;
        }
        const newFunc = { nome, user, pass, admin: false };
        await addDoc(collection(db, 'funcionarios'), newFunc);
        document.getElementById('funcNome').value = '';
        document.getElementById('funcUser').value = '';
        document.getElementById('funcPass').value = '';
        await renderizarFuncionarios();
        mostrarNotificacao('Funcionário adicionado com sucesso!', 'sucesso');
    }

    async function renderizarFuncionarios() {
        const funcs = await getFuncionarios();
        const div = document.getElementById('listaFuncionarios');
        div.innerHTML = '';
        funcs.forEach(f => {
            const adminText = f.admin ? ' - Admin' : '';
            const removeBtn = f.admin ? '' : `<button class="btn-top btn-danger btn-small" onclick="removerFuncionario('${f.id}')">Remover</button>`;
            div.insertAdjacentHTML('beforeend', `
                <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${escapeHTML(f.nome)} (${f.user})${adminText}</span>
                    ${removeBtn}
                </div>
            `);
        });
        if (!funcs.length) div.innerHTML = '<p>Nenhum funcionário cadastrado.</p>';
    }

    async function removerFuncionario(id) {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        if (!confirm('Remover funcionário?')) return;
        await deleteDoc(doc(db, 'funcionarios', id));
        await renderizarFuncionarios();
    }

    async function removerCooperado(id, event) {
        event.stopPropagation();
        if (!confirm('Confirma remoção deste cooperado?')) return;
        const item = event.target.closest('.list-item');
        if (item) item.classList.add('fade-out');
        await deleteDoc(doc(db, 'associados', id));
        setTimeout(() => {
            filtrarModal();
        }, 400);
    }

    function removerAcentos(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function addDependente() {
        window.deps.push({ nome: '', parent: '', nasc: '', cpf: '', plano: '' });
        renderDeps();
    }

    function renderDeps() {
        const div = document.getElementById('depsList');
        div.innerHTML = '';
        window.deps.forEach((d, i) => {
            div.insertAdjacentHTML('beforeend', `
                <div class="row" style="align-items:end;">
                    <div class="col"><label>Nome</label><input value="${escapeHTML(d.nome)}" onchange="window.deps[${i}].nome=this.value"></div>
                    <div class="col"><label>Parentesco</label><input value="${escapeHTML(d.parent)}" onchange="window.deps[${i}].parent=this.value"></div>
                    <div class="col"><label>Nasc.</label><input type="date" value="${d.nasc}" onchange="window.deps[${i}].nasc=this.value"></div>
                    <div class="col"><label>CPF</label><input value="${escapeHTML(d.cpf)}" onchange="window.deps[${i}].cpf=this.value"></div>
                    <div class="col"><label>Plano</label>
                        <select onchange="window.deps[${i}].plano=this.value">
                            <option value="">Nenhum</option>
                            <option value="224" ${d.plano==='224'?'selected':''}>Alfa (224)</option>
                            <option value="226" ${d.plano==='226'?'selected':''}>Bravo (226)</option>
                            <option value="228" ${d.plano==='228'?'selected':''}>Delta (228)</option>
                        </select>
                    </div>
                    <div class="col"><button type="button" class="btn-top btn-danger" onclick="window.deps.splice(${i},1); renderDeps()">Remover</button></div>
                </div>
            `);
        });
    }

    async function buildResumo() {
        const r = document.getElementById('resumoContent');
        r.innerHTML = '';

        const editId = document.getElementById('editIndex').value;
        if (!editId) {
            r.innerHTML = '<p>Selecione ou crie um cooperado para ver o resumo.</p>';
            return;
        }
        const docSnap = await getDoc(doc(db, 'associados', editId));
        if (!docSnap.exists()) {
            r.innerHTML = '<p>Cooperado não encontrado.</p>';
            return;
        }
        const a = docSnap.data();

        const nome = a.nome || '—';
        const cpf = a.cpf || '—';
        const planoTit = a.plano;
        const valorTit = valorPlano(planoTit);
        r.insertAdjacentHTML('beforeend', `
            <div class="resumo-block">
                <h3>Titular</h3>
                <div class="resumo-line"><span>Nome:</span><span>${escapeHTML(nome)}</span></div>
                <div class="resumo-line"><span>CPF:</span><span>${cpf}</span></div>
                <div class="resumo-line"><span>Plano:</span><span>${planoTit || '—'} - R$ ${valorTit.toFixed(2)}</span></div>
            </div>
        `);

        let total = valorTit;
        if (a.dependentes && a.dependentes.length) {
            r.insertAdjacentHTML('beforeend', '<h3>Dependentes</h3>');
            a.dependentes.forEach(d => {
                const v = valorPlano(d.plano);
                total += v;
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-line">
                        <span>${escapeHTML(d.nome || '—')} (${escapeHTML(d.parent || '—')}) - CPF: ${d.cpf || '—'} - Plano: ${d.plano || '—'}</span>
                        <span>R$ ${v.toFixed(2)}</span>
                    </div>
                `);
            });
        }

        const conj = a.conjuge || {};
        const conjNome = conj.nome || '';
        const conjCpf = conj.cpf || '—';
        const conjNasc = conj.nasc || '—';
        const conjPlano = conj.plano;
        const conjValor = valorPlano(conjPlano);
        if (conjNome) {
            r.insertAdjacentHTML('beforeend', '<h3>Cônjuge</h3>');
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-line">
                    <span>${escapeHTML(conjNome)} - CPF: ${conjCpf} - Nasc: ${conjNasc} - Plano: ${conjPlano || '—'}</span>
                    <span>R$ ${conjValor.toFixed(2)}</span>
                </div>
            `);
            total += conjValor;
        }

        let months = 0;
        let totalPaid = 0;
        if (a.dataAssociacao) {
            const joinDate = new Date(a.dataAssociacao);
            const now = new Date();
            months = (now.getFullYear() - joinDate.getFullYear()) * 12 + (now.getMonth() - joinDate.getMonth());
            if (now.getDate() < joinDate.getDate()) months--;
            months = Math.max(months, 0);
            totalPaid = months * total;
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Histórico</h3>
                    <div class="resumo-line"><span>Data de Associação:</span><span>${a.dataAssociacao}</span></div>
                    <div class="resumo-line"><span>Meses Cooperado:</span><span>${months}</span></div>
                    <div class="resumo-line"><span>Total Pago (estimado):</span><span>R$ ${totalPaid.toFixed(2)}</span></div>
                </div>
            `);
        } else {
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Histórico</h3>
                    <p>Data de Associação não informada.</p>
                </div>
            `);
        }

        let pend = [];
        if (!a.cpf) pend.push('CPF do titular faltando');
        if (!a.nasc) pend.push('Data de nascimento do titular faltando');
        a.dependentes?.forEach((d, i) => {
            if (d.nome) {
                if (!d.cpf) pend.push(`CPF do dependente ${i+1} (${escapeHTML(d.nome)}) faltando`);
                if (!d.nasc) pend.push(`Data de nascimento do dependente ${i+1} (${escapeHTML(d.nome)}) faltando`);
            }
        });
        if (conjNome) {
            if (!conj.cpf) pend.push('CPF do cônjuge faltando');
            if (!conj.nasc) pend.push('Data de nascimento do cônjuge faltando');
        }
        if (pend.length) {
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Pendências</h3>
                    <ul>${pend.map(p => `<li>${p}</li>`).join('')}</ul>
                </div>
            `);
        }

        r.insertAdjacentHTML('beforeend', `
            <div class="total">Total Mensal: R$ ${total.toFixed(2)}</div>
        `);
    }

    async function abrirResumoGeral() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado. Apenas administradores podem acessar o resumo geral.', 'erro');
            return;
        }
        document.getElementById('modalResumoGeral').classList.add('active');
        await buildResumoGeral();
    }

    function fecharResumoGeral() {
        document.getElementById('modalResumoGeral').classList.remove('active');
    }

    async function buildResumoGeral() {
        const r = document.getElementById('resumoGeralContent');
        r.innerHTML = '<h2>Resumo Geral - CBSaúde Cooperados</h2>';

        const lista = await getData();
        let totalGeral = 0;
        let countCooperados = lista.length;

        for (const a of lista) {
            let totalIndividual = valorPlano(a.plano);
            a.dependentes?.forEach(d => totalIndividual += valorPlano(d.plano));
            if (a.conjuge?.nome) totalIndividual += valorPlano(a.conjuge.plano);
            totalGeral += totalIndividual;

            const obs = a.obs ? `<p>Observações: ${escapeHTML(a.obs)}</p>` : '';

            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>${escapeHTML(a.nome)}</h3>
                    <div class="resumo-line"><span>CPF:</span><span>${a.cpf || '—'}</span></div>
                    <div class="resumo-line"><span>Total Mensal:</span><span>R$ ${totalIndividual.toFixed(2)}</span></div>
                    ${obs}
                </div>
            `);
        }

        r.insertAdjacentHTML('beforeend', `
            <div class="resumo-block">
                <h3>Totais</h3>
                <div class="resumo-line"><span>Número de Cooperados:</span><span>${countCooperados}</span></div>
                <div class="total">Total Geral Mensal: R$ ${totalGeral.toFixed(2)}</div>
            </div>
        `);
    }

    function valorPlano(cod) {
        switch (cod) {
            case '224': return 20;
            case '226': return 115;
            case '228': return 155;
            default: return 0;
        }
    }

    function resetAll() {
        document.getElementById('associadoForm').reset();
        document.getElementById('editIndex').value = '';
        window.deps = [];
        renderDeps();
    }

    async function editAssociado(id) {
        const docSnap = await getDoc(doc(db, 'associados', id));
        if (docSnap.exists()) {
            const a = docSnap.data();
            document.getElementById('editIndex').value = id;

            // Preencher campos principais (excluindo dependentes e conjuge)
            Object.keys(a).forEach(k => {
                if (k !== 'id' && k !== 'dependentes' && k !== 'conjuge') {
                    const el = document.getElementById(k);
                    if (el) el.value = a[k] || '';
                }
            });

            window.deps = a.dependentes || [];
            renderDeps();
            const conj = a.conjuge || {};
            document.getElementById('conjNome').value = conj.nome || '';
            document.getElementById('conjCpf').value = conj.cpf || '';
            document.getElementById('conjNasc').value = conj.nasc || '';
            document.getElementById('conjPlano').value = conj.plano || '';

            switchTab('dados');
            fecharPesquisa();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Salvar dados
    async function saveAll(event) {
        if (event) event.preventDefault();
        const form = document.getElementById('associadoForm');
        const editId = document.getElementById('editIndex').value;
        
        const associado = {
            nome: form.nome.value.trim(),
            cpf: form.cpf.value,
            pasta: form.pasta.value,
            matricula: form.matricula.value,
            nasc: form.nasc.value,
            dataAssociacao: form.dataAssociacao.value,
            sexo: form.sexo.value,
            civil: form.civil.value,
            endereco: form.endereco.value,
            numero: form.numero.value,
            bairro: form.bairro.value,
            municipio: form.municipio.value,
            estado: form.estado.value,
            cep: form.cep.value,
            telefone: form.telefone.value,
            email: form.email.value,
            plano: form.plano.value,
            obs: form.obs.value,
            dependentes: window.deps,
            conjuge: {
                nome: form.conjNome.value,
                cpf: form.conjCpf.value,
                nasc: form.conjNasc.value,
                plano: form.conjPlano.value
            }
        };

        if (!associado.nome || !associado.cpf) {
            mostrarNotificacao('Nome e CPF são obrigatórios para o titular.', 'erro');
            return;
        }

        if (associado.cpf && !validarCPF(associado.cpf)) {
            mostrarNotificacao('CPF do titular é inválido.', 'erro');
            return;
        }

        const conj = associado.conjuge;
        if (conj.cpf && !validarCPF(conj.cpf)) {
            mostrarNotificacao('CPF do cônjuge é inválido.', 'erro');
            return;
        }

        try {
            if (editId) {
                await setDoc(doc(db, 'associados', editId), associado);
            } else {
                await addDoc(collection(db, 'associados'), associado);
            }
            resetAll();
            mostrarNotificacao('Dados salvos com sucesso!', 'sucesso');
        } catch (error) {
            console.error('Erro ao salvar:', error);
            mostrarNotificacao('Erro ao salvar os dados. Tente novamente.', 'erro');
        }
    }

    // Inicialização do admin
    async function initAdmin() {
        const funcs = await getFuncionarios();
        if (!funcs.find(f => f.user === 'admin')) {
            await addDoc(collection(db, 'funcionarios'), { nome: 'Administrador', user: 'admin', pass: '1234', admin: true });
        }
    }

    window.deps = [];

    // Expor funções para escopo global
    window.doLogin = doLogin;
    window.doLogout = doLogout;
    window.abrirPesquisa = abrirPesquisa;
    window.fecharPesquisa = fecharPesquisa;
    window.novo = novo;
    window.gravar = gravar;
    window.alterar = alterar;
    window.imprimirPDF = imprimirPDF;
    window.switchTab = switchTab;
    window.addDependente = addDependente;
    window.adicionarFuncionario = adicionarFuncionario;
    window.fecharGerenciaFuncionarios = fecharGerenciaFuncionarios;
    window.abrirGerenciaFuncionarios = abrirGerenciaFuncionarios;
    window.abrirResumoGeral = abrirResumoGeral;
    window.fecharResumoGeral = fecharResumoGeral;
    window.editAssociado = editAssociado;
    window.removerCooperado = removerCooperado;
    window.debouncedFilter = debouncedFilter;
    window.saveAll = saveAll;

    window.onload = async () => {
        await initAdmin();
        document.getElementById('userInput').focus();

        // Formatação automática
        document.getElementById('cpf').addEventListener('blur', function() {
            this.value = formatarCPF(this.value);
            if (this.value && !validarCPF(this.value)) {
                mostrarNotificacao('CPF inválido!', 'erro');
                this.focus();
            }
        });
        document.getElementById('telefone').addEventListener('blur', function() {
            this.value = formatarTelefone(this.value);
        });
        document.getElementById('cep').addEventListener('blur', function() {
            this.value = formatarCEP(this.value);
        });
        document.getElementById('conjCpf').addEventListener('blur', function() {
            this.value = formatarCPF(this.value);
            if (this.value && !validarCPF(this.value)) {
                mostrarNotificacao('CPF do cônjuge inválido!', 'erro');
                this.focus();
            }
        });
    };
</script>
</body>
</html>