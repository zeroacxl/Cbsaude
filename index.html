<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CBSaúde Cooperados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Cores principais */
            --azul: #0066cc;
            --azul-escuro: #004c99;
            --azul-claro: #e6f2ff;
            --branco: #ffffff;
            --cinza: #f8fafc;
            --texto: #1a2533;
            --texto-suave: #566b85;
            --borda: #d1dce8;
            
            /* Estados e feedback */
            --erro: #dc3545;
            --sucesso: #28a745;
            --aviso: #ffc107;
            --info: #17a2b8;
            
            /* Status do cooperado */
            --status-ativo: #28a745;
            --status-inativo: #6c757d;
            --status-aposentado: #17a2b8;
            --status-falecido: #343a40;
            --status-pensionista: #6f42c1;
            
            /* Efeitos e transições */
            --transicao: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sombra: 0 4px 8px rgba(0, 0, 0, 0.1);
            --sombra-hover: 0 8px 16px rgba(0, 0, 0, 0.15);
            --sombra-inset: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            --sombra-foco: 0 0 0 3px rgba(0, 102, 204, 0.25);
            --gradient-bg: linear-gradient(135deg, var(--azul-claro), var(--branco));
        }
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Roboto, sans-serif;
        }
        body {
            margin: 0;
            background: linear-gradient(135deg, #f0f4ff, #ffffff);
            color: var(--texto);
            font-size: clamp(14px, 2.5vw, 16px);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            transition: background var(--transicao);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(37, 99, 235, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Efeito Aero Glass para cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.6);
        }

        /* Animação de entrada para elementos principais */
        .container {
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: .8rem;
            align-items: center;
            justify-content: space-between;
            animation: slideInDown 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .top-bar h1 {
            margin: 0;
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: var(--azul-escuro);
            text-shadow: 1px 1px 2px rgba(0,0,0,.1);
            transition: color var(--transicao);
        }
        .top-bar h1:hover {
            color: var(--azul);
        }
        .btn-top {
            background: var(--azul);
            color: #fff;
            border: none;
            padding: .7rem 1.2rem;
            border-radius: 8px;
            box-shadow: var(--sombra);
            cursor: pointer;
            transition: all var(--transicao);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-top:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-top:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--sombra-hover);
            background: var(--azul-escuro);
        }
        
        .btn-top:active:not(:disabled) {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--sombra);
        }
        
        .btn-top::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease-in-out;
        }
        
        .btn-top:hover::after {
            transform: translateX(100%);
        }
        .btn-top.imprimir {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }
        .btn-top.sair {
            background: linear-gradient(145deg, #c62828, #8e0000);
            margin-left: auto;
        }
        
        /* Estilo do Spinner de Carregamento */
        .btn-top .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(255,255,255,0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: .5em;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            background: var(--branco);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
        }
        .tabs {
            display: flex;
            gap: .3rem;
            min-width: max-content;
            transition: all var(--transicao);
        }
        .tab {
            padding: .6rem 1rem;
            background: linear-gradient(145deg, var(--branco), var(--azul-claro));
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            box-shadow: var(--sombra-inset);
            white-space: nowrap;
            transition: all var(--transicao);
        }
        .tab:hover {
            transform: translateY(-2px);
            background: var(--azul-claro);
        }
        .tab.active {
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            transform: translateY(0);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: .8rem;
            animation: fadeIn 0.6s ease-in-out;
        }
        .card {
            background: var(--branco);
            border-radius: 12px;
            box-shadow: var(--sombra);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: scaleIn 0.4s ease-out;
            transition: all var(--transicao);
        }
        
        .card:hover {
            box-shadow: var(--sombra-hover);
            transform: translateY(-4px) scale(1.01);
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: .8rem;
            transition: all var(--transicao);
            margin-bottom: 1rem; /* MELHORIA: Adiciona espaço vertical */
        }
        .col {
            flex: 1 1 260px;
            display: flex;
            flex-direction: column;
            transition: transform var(--transicao);
        }
        .col:hover {
            transform: translateY(-2px);
        }
        label {
            margin-bottom: .3rem;
            font-weight: 600;
            color: var(--azul-escuro);
            transition: color var(--transicao);
        }
        input, select, textarea {
            width: 100%;
            padding: .7rem .8rem;
            font-size: 1em;
            color: var(--texto);
            background: var(--branco);
            border: 1px solid var(--borda);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
            transition: all var(--transicao);
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: var(--azul);
            transform: scale(1.02);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--azul);
            box-shadow: var(--sombra-foco);
            transform: scale(1.02);
        }
        
        input:disabled, select:disabled, textarea:disabled {
            background: var(--cinza);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* CORREÇÃO BUG: Estilo para readonly (aplicado via JS de permissões) */
        input[readonly], select[readonly], textarea[readonly] {
             background: var(--cinza);
             cursor: not-allowed;
             opacity: 0.7;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .hidden {
            display: none;
        }
        .tabContent {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            transition: opacity var(--transicao), transform var(--transicao);
        }
        .tabContent.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
                filter: blur(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding: 4vh 1rem;
            z-index: 200;
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            animation: modalOpen 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        /* Efeitos Glass e Dashboard */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .glass-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .dashboard-header {
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-date {
            color: var(--texto-suave);
            font-size: 0.9em;
        }

                /* Estilos do Resumo Geral */
        .resumo-titulo {
            color: var(--azul-escuro);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .resumo-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .resumo-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .resumo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .resumo-card h3 {
            color: var(--texto-suave);
            font-size: 1em;
            margin: 0 0 10px 0;
        }

        .resumo-card .numero {
            color: var(--azul-escuro);
            font-size: 1.8em;
            font-weight: bold;
        }

        .resumo-card.destaque {
            background: linear-gradient(135deg, var(--azul), var(--azul-escuro));
            color: white;
        }

        .resumo-card.destaque h3,
        .resumo-card.destaque .numero {
            color: white;
        }

        .erro-mensagem {
            color: var(--erro);
            text-align: center;
            padding: 20px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
            margin: 20px;
        }

        @keyframes modalOpen {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes cardSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes iconPop {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .modal-header {
            padding: .8rem 1rem;
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--azul-escuro); /* Melhoria Visual */
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 1rem 1.2rem;
            font-size: 1.1em;
            border: 2px solid var(--azul-claro);
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all var(--transicao);
            background: var(--branco);
            color: var(--texto);
        }
        .search-input:focus {
            border-color: var(--azul);
            transform: translateY(-2px);
            box-shadow: var(--sombra-foco);
            outline: none;
        }
        
        .detalhes-cooperado {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            color: var(--texto-suave);
        }
        
        .termo-destacado {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0 2px;
            border-radius: 3px;
        }
        
        #modalResults {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        #modalResults::-webkit-scrollbar {
            width: 8px;
        }
        
        #modalResults::-webkit-scrollbar-track {
            background: var(--azul-claro);
            border-radius: 4px;
        }
        
        #modalResults::-webkit-scrollbar-thumb {
            background: var(--azul);
            border-radius: 4px;
        }
        
        #modalResults::-webkit-scrollbar-thumb:hover {
            background: var(--azul-escuro);
        }
        .list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--borda);
            cursor: pointer;
            transition: all var(--transicao);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--branco);
            box-shadow: var(--sombra);
        }
        
        .list-item:hover {
            background: var(--azul-claro);
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--sombra-hover);
        }
        
        .list-item:active {
            transform: translateY(2px) scale(0.98);
        }
        .list-item span {
            display: block;
            font-weight: 600;
        }
        .list-item small {
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .95em;
        }
        th, td {
            padding: .6rem .5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: var(--azul-claro);
            color: var(--azul-escuro);
        }
        tr:hover {
            background: #f1f8ff;
            transition: background var(--transicao);
        }
        .actions {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: .4rem .6rem;
            font-size: .85em;
        }
        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333) !important;
        }
        .resumo-block {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            animation: fadeIn 0.5s;
        }
        .resumo-line {
            display: flex;
            justify-content: space-between;
            padding: .5rem 0;
            border-bottom: 1px dotted #ddd;
            transition: background var(--transicao);
        }
        .resumo-line:hover {
            background: var(--azul-claro);
        }
        .total {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid var(--azul);
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            color: var(--azul-escuro);
            animation: scaleIn 0.4s;
        }
        .fade-out {
            animation: fadeOut .4s forwards;
        }
        @keyframes fadeOut {
            to { 
                opacity: 0; 
                transform: translateY(30px);
                filter: blur(5px);
            }
        }

        .notificacao {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            box-shadow: var(--sombra-hover);
            z-index: 1000;
            min-width: 200px;
            text-align: center;
            animation: slideIn 0.4s ease-out, fadeOut 0.4s 2.6s forwards;
        }

        .notificacao.sucesso {
            background: var(--sucesso);
        }

        .notificacao.erro {
            background: var(--erro);
        }

        .notificacao.info {
            background: var(--azul);
        }

        .notificacao.aviso {
            background: var(--aviso);
        }
        
        /* Estilos para modo somente leitura e permissões */
        .read-only-mode .form-control {
            opacity: 0.8;
            pointer-events: none;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            border-radius: 4px;
            background: var(--azul-claro);
            transition: all var(--transicao);
        }

        .permission-item:hover {
            background: var(--azul-claro);
            transform: translateY(-2px);
        }

        .permission-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .permissions-grid {
            background: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
        }

        /* Estilos para o grid de funcionários */
        .funcionarios-grid {
            display: grid;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .funcionario-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--sombra);
            transition: all var(--transicao);
            border: 1px solid var(--borda);
        }

        .funcionario-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover);
        }

        .funcionario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--borda);
        }

        .funcionario-nome {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--azul-escuro);
        }

        .funcionario-tipo {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            background: var(--azul-claro);
            color: var(--azul-escuro);
        }

        .funcionario-permissions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .permission-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--cinza);
            transition: all var(--transicao);
        }

        .permission-toggle:hover {
            background: var(--azul-claro);
        }

        .permission-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .permission-label {
            font-size: 0.9em;
            color: var(--texto);
        }

        .funcionario-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--borda);
        }
        
        /* Estilos para os status dos cooperados */
        [class^="status-"] {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9em;
        }

        /* Classes de status baseadas nos VALORES do select */
        .status-ativo { 
            background-color: var(--status-ativo);
            color: white;
        }
        .status-inativo { 
            background-color: var(--status-inativo);
            color: white;
        }
        .status-aposentado { 
            background-color: var(--status-aposentado);
            color: white;
        }
        .status-falecido { 
            background-color: var(--status-falecido);
            color: white;
        }
        .status-pensionista { 
            background-color: var(--status-pensionista);
            color: white;
        }
        .status-reformado { 
            background-color: var(--azul);
            color: white;
        }
        .status-funcionario_civil { 
            background-color: var(--info);
            color: white;
        }
        .status-funcionario_civil_aposentado { 
            background-color: var(--texto-suave);
            color: white;
        }
        .status-ex_bombeiro { 
            background-color: var(--aviso);
            color: white;
        }
        
        .login-box h2 {
            color: var(--azul-escuro);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .login-box label {
            margin-top: 1rem;
        }
        
        .login-box .btn-top {
            width: 100%;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

<section id="loginScreen" class="container login-box">
    <div class="card" style="max-width:400px;margin:10vh auto; animation: scaleIn 0.6s ease-out;">
        <h1 style="color: var(--azul-escuro); text-align: center; margin-top: 0; text-shadow: 1px 1px 2px rgba(0,0,0,.1);">
            CBSaúde Cooperados
        </h1>
        <h2 style="margin-top: 0;">Login</h2>
        <label>Usuário</label>
        <input id="userInput" type="text" placeholder="Digite seu usuário">
        <label>Senha</label>
        <input id="passInput" type="password" placeholder="Digite sua senha">
        <button class="btn-top" onclick="doLogin()">Entrar</button>
        </div>
</section>

<section id="mainApp" class="hidden">
    <div class="top-bar">
        <h1>CBSaúde Cooperados</h1>
        <button class="btn-top" onclick="abrirPesquisa()">Procurar</button>
        <button class="btn-top hidden" onclick="alterar()">Alterar</button>
        <button class="btn-top" onclick="gravar(event)" id="btnGravar">Gravar</button>
        <button class="btn-top" onclick="novo()" id="btnNovo">Novo</button>
        <button class="btn-top imprimir" onclick="imprimirPDF()">PDF</button>
        <button class="btn-top" onclick="abrirResumoGeral()" id="btnResumoGeral">Resumo Geral</button>
        <button class="btn-top" onclick="abrirGerenciaFuncionarios()" id="btnGerencia">Gerenciar Funcionários</button>
        <button class="btn-top sair" onclick="doLogout()">Sair</button>
    </div>

    <div class="container">
        <div class="card">
            <form id="associadoForm">
                <input id="editIndex" type="hidden">

                <div class="tabs-wrapper">
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('dados')">Dados Pessoais</div>
                        <div class="tab" onclick="switchTab('dependentes')">Dependentes</div>
                        <div class="tab" onclick="switchTab('conjuge')">Cônjuge</div>
                        <div class="tab" onclick="switchTab('resumo')">Resumo Individual</div>
                    </div>
                </div>

                <div id="dados" class="tabContent active">
                    <h3>Dados Pessoais</h3>
                    <div class="row">
                        <div class="col"><label>Nome *</label><input id="nome" required></div>
                        <div class="col"><label>CPF *</label><input id="cpf" required></div>
                        <div class="col"><label>Nº da Pasta</label><input id="pasta"></div>
                        <div class="col"><label>Matrícula</label><input id="matricula"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Status/Tipo de Cooperado *</label>
                            <select id="statusParentesco" required>
                                <option value="">Selecione...</option>
                                <option value="ATIVO">Ativo</option>
                                <option value="INATIVO">Inativo</option>
                                <option value="APOSENTADO">Aposentado</option>
                                <option value="FALECIDO">Falecido</option>
                                <option value="PENSIONISTA">Pensionista</option>
                                <option value="REFORMADO">Reformado</option>
                                <option value="FUNCIONARIO_CIVIL">Funcionário Civil</option>
                                <option value="FUNCIONARIO_CIVIL_APOSENTADO">Funcionário Civil Aposentado</option>
                                <option value="EX_BOMBEIRO">Ex-Bombeiro</option>
                            </select>
                        </div>
                        <div class="col"><label>Data de Associação</label><input id="dataAssociacao" type="date"></div>
                        <div class="col"><label>Data Nasc.</label><input id="nasc" type="date"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Sexo</label>
                            <select id="sexo">
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Não-binário</option>
                                <option>Trans</option>
                            </select>
                        </div>
                        <div class="col"><label>Estado Civil</label>
                            <select id="civil">
                                <option>Solteiro(a)</option><option>Casado(a)</option><option>Divorciado(a)</option><option>Viúvo(a)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Endereço</label><input id="endereco"></div>
                        <div class="col"><label>Número</label><input id="numero"></div>
                        <div class="col"><label>Bairro</label><input id="bairro"></div>
                        <div class="col"><label>Município</label><input id="municipio"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Estado</label><input id="estado" maxlength="2"></div>
                        <div class="col"><label>CEP</label><input id="cep"></div>
                        <div class="col"><label>Telefone</label><input id="telefone"></div>
                        <div class="col"><label>E-mail</label><input id="email" type="email"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Plano</label>
                            <select id="plano">
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Observações</label><textarea id="obs"></textarea></div>
                    </div>
                    <small>* Campos obrigatórios apenas para o titular. Dependentes e cônjuge podem ser salvos parcialmente.</small>
                </div>

                <div id="dependentes" class="tabContent">
                    <h3>Dependentes</h3>
                    <div id="depsList"></div>
                    <button type="button" class="btn-top" onclick="addDependente()">+ Dependente</button>
                </div>

                <div id="conjuge" class="tabContent">
                    <h3>Cônjuge</h3>
                    <div class="row">
                        <div class="col"><label>Nome</label><input id="conjNome"></div>
                        <div class="col"><label>CPF</label><input id="conjCpf"></div>
                        <div class="col"><label>Data Nasc.</label><input id="conjNasc" type="date"></div>
                        <div class="col"><label>Plano</label>
                            <select id="conjPlano">
                                <option value="">Nenhum</option>
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="resumo" class="tabContent">
                    <h3>Resumo Individual</h3>
                    <div id="resumoContent"></div>
                </div>
            </form>
        </div>
    </div>
</section>

<div id="modalPesquisa" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Pesquisar Cooperado</span>
            <button class="btn-top" onclick="fecharPesquisa()">✖</button>
        </div>
        <div class="modal-body">
            <input class="search-input" id="searchModalInput" placeholder="Digite nome ou CPF..." onkeyup="debouncedFilter()">
            <div id="modalResults"></div>
        </div>
    </div>
</div>

    <div id="modalFuncionarios" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <span>Gerenciar Funcionários</span>
            <button class="btn-top" onclick="fecharGerenciaFuncionarios()">✖</button>
        </div>
        <div class="modal-body">
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="margin-top: 0;">Adicionar Novo Funcionário</h4>
                <div class="row">
                    <div class="col"><label>Nome Completo *</label><input id="funcNome" placeholder="Nome do funcionário"></div>
                    <div class="col"><label>Usuário *</label><input id="funcUser" placeholder="Login de acesso"></div>
                    <div class="col"><label>Senha *</label><input id="funcPass" type="password" placeholder="Senha de acesso"></div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn-top" onclick="adicionarFuncionario()" style="width: 200px;">
                        <i class="fas fa-plus"></i> Adicionar Funcionário
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">Funcionários Cadastrados</h4>
                    <input type="text" id="searchFunc" placeholder="Buscar funcionário..." 
                           style="width: 250px; margin: 0;" 
                           onkeyup="filtrarFuncionarios()">
                </div>
                <div class="funcionarios-grid" id="listaFuncionarios"></div>
            </div>
        </div>
    </div>
</div><div id="modalResumoGeral" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Resumo Geral</span>
            <button class="btn-top" onclick="fecharResumoGeral()">✖</button>
        </div>
        <div class="modal-body">
            <div id="resumoGeralContent"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, getDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBexxAzdyVtthakeOVfTf-PxnlQ5rNynRQ",
        authDomain: "cbsaudecooperados.firebaseapp.com",
        projectId: "cbsaudecooperados",
        storageBucket: "cbsaudecooperados.firebasestorage.app",
        messagingSenderId: "558244165893",
        appId: "1:558244165893:web:2e10e9560c896f43e6df6c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Cache para a pesquisa
    let cooperadosCache = [];
    
    // LIMPEZA: Removido 'tiposCooperadosCache' e funções de carregamento dinâmico
    // que estavam conflitantes e inacabadas.
    
    let cacheReady = false;

    // ---------- FUNÇÕES UTILITÁRIAS ----------
    function escapeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatarTelefone(tel) {
        tel = tel.replace(/\D/g, '');
        if (tel.length === 11) {
            return tel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
        return tel.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }

    function formatarCEP(cep) {
        cep = cep.replace(/\D/g, '');
        return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }

    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
            return false;
        }
        
        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        
        let resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(9))) return false;
        
        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(10))) return false;
        
        return true;
    }

    async function getData() {
        try {
            const q = query(collection(db, 'associados'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function getFuncionarios() {
        try {
            const q = query(collection(db, 'funcionarios'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    // ---------- FUNÇÕES GLOBAIS (BOTÕES E NAVEGAÇÃO) ----------
    // Sistema de notificações
    function mostrarNotificacao(mensagem, tipo = 'info', duracao = 3000) {
        const div = document.createElement('div');
        div.className = `notificacao ${tipo} animate-slide-in`;
        div.textContent = mensagem;
        document.body.appendChild(div);
        
        setTimeout(() => {
            div.classList.add('fade-out');
            setTimeout(() => div.remove(), 400);
        }, duracao - 400);
    }

    // Debounce para busca
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function removerAcentos(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function valorPlano(cod) {
        switch (cod) {
            case '224': return 20;
            case '226': return 115;
            case '228': return 155;
            default: return 0;
        }
    }

    // Exportar funções para o escopo global
    
    // CORREÇÃO BUG: Função de permissões atualizada para usar IDs
    function aplicarPermissoes(user) {
        try {
            // Se for admin, tem todas as permissões
            if (user.admin) {
                document.body.classList.remove('read-only-mode');
                // Garante que campos desabilitados por engano sejam reabilitados
                document.querySelectorAll('#associadoForm input, #associadoForm select, #associadoForm textarea').forEach(el => {
                    el.removeAttribute('readonly');
                    el.disabled = false;
                    el.style.backgroundColor = '';
                    el.style.cursor = '';
                });
                document.querySelectorAll('#dependentes button').forEach(btn => {
                    btn.style.display = 'inline-flex';
                });
                return;
            }

            // Garante que as permissões existam
            const permissions = user.permissions || {
                canRead: true,      // Permissão padrão de leitura
                canCreate: false,
                canEdit: false,
                canDelete: false,
                canManageUsers: false,
                canViewSummary: true
            };

            // Mapeamento de elementos e suas permissões necessárias (usando IDs)
            const elementos = {
                'btnGravar': 'canEdit',
                'btnNovo': 'canCreate',
                'btnResumoGeral': 'canViewSummary',
                'btnGerencia': 'canManageUsers'
            };

            // Aplica as permissões aos elementos
            Object.entries(elementos).forEach(([id, permissionNeeded]) => {
                const elemento = document.getElementById(id); // CORREIDO: Busca apenas por ID
                if (elemento) {
                    if (permissions[permissionNeeded]) {
                        elemento.style.display = 'inline-flex';
                    } else {
                        elemento.style.display = 'none';
                    }
                }
            });

            // Controle de edição (CORREÇÃO: Focado apenas no #associadoForm)
            const canEdit = permissions.canEdit;
            document.querySelectorAll('#associadoForm input, #associadoForm select, #associadoForm textarea').forEach(el => {
                if (!canEdit) {
                    el.setAttribute('readonly', 'true');
                    el.style.cursor = 'not-allowed';
                    // 'disabled' impede o envio do formulário, 'readonly' é melhor
                } else {
                    el.removeAttribute('readonly');
                    el.style.cursor = '';
                }
            });

            // Controle de dependentes (CORREÇÃO: Focado apenas nos botões de dependentes)
            document.querySelectorAll('#dependentes button[onclick*="addDependente"], #dependentes button[onclick*="window.deps.splice"]').forEach(btn => {
                btn.style.display = canEdit ? 'inline-flex' : 'none';
            });

            // A lógica de remoção é tratada em 'mostrarResultado'
            
            // Modo somente leitura
            if (!canEdit) {
                document.body.classList.add('read-only-mode');
            } else {
                document.body.classList.remove('read-only-mode');
            }

        } catch (error) {
            console.error('Erro ao aplicar permissões:', error);
            // Em caso de erro, aplica o modo mais restritivo por segurança
            document.body.classList.add('read-only-mode');
            document.querySelectorAll('button:not([onclick*="doLogout"])').forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }

    window.doLogin = async function() {
        const btnLogin = document.querySelector('button[onclick="doLogin()"]');
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();
        
        if (!u || !p) {
            mostrarNotificacao('Preencha todos os campos', 'erro');
            return;
        }

        btnLogin.disabled = true;
        btnLogin.innerHTML = 'Entrando... <span class="spinner"></span>';
        
        setTimeout(async () => {
            const funcs = await getFuncionarios();
            const user = funcs.find(f => f.user === u && f.pass === p);
            
            if (user) {
                window.usuarioLogado = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Aplica as permissões baseadas no tipo de usuário
                aplicarPermissoes(user);

                // Mostra mensagem de boas-vindas com o tipo de acesso
                const tipoAcesso = user.admin ? 'Administrador' : 'Operador';
                mostrarNotificacao(`Bem-vindo, ${user.nome}! (${tipoAcesso})`, 'sucesso');
            } else {
                mostrarNotificacao('Usuário ou senha inválidos', 'erro');
                document.getElementById('passInput').value = '';
                document.getElementById('passInput').focus();
            }
            
            btnLogin.disabled = false;
            btnLogin.innerHTML = 'Entrar';
        }, 800);
    };

    window.doLogout = function() {
        if (confirm('Deseja realmente sair?')) {
            window.usuarioLogado = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('userInput').value = '';
            document.getElementById('passInput').value = '';
            // Oculta botões de admin ao sair
            document.getElementById('btnGerencia').style.display = 'none';
            document.getElementById('btnResumoGeral').style.display = 'none';
            mostrarNotificacao('Você saiu do sistema', 'info');
        }
    };

    window.abrirPesquisa = async function() {
        const modal = document.getElementById('modalPesquisa');
        const input = document.getElementById('searchModalInput');
        const resultsDiv = document.getElementById('modalResults');

        modal.classList.add('active');
        input.value = '';
        
        // Mostra mensagem de carregamento
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="spinner"></span> Carregando cooperados...</div>';
        
        try {
            // Atualiza o cache se necessário
            if (!cacheReady) {
                cooperadosCache = await getData();
                cacheReady = true;
            }
            
            // Mostra todos os cooperados inicialmente
            filtrarModal();
            
            // Foca no campo de busca
            input.focus();
            
        } catch (erro) {
            resultsDiv.innerHTML = '<p style="color: var(--erro); text-align: center;">Erro ao carregar dados. Tente novamente.</p>';
            console.error('Erro ao carregar cooperados:', erro);
        }
    };

    window.fecharPesquisa = function() {
        document.getElementById('modalPesquisa').classList.remove('active');
    };

    window.novo = function() {
        resetAll();
        switchTab('dados');
        mostrarNotificacao('Novo cooperado iniciado', 'info');
    };

    window.gravar = async function(event) {
        const btnGravar = document.getElementById('btnGravar');
        btnGravar.disabled = true;
        btnGravar.innerHTML = 'Gravando... <span class="spinner"></span>';
        
        await saveAll(event); // Passa o evento
        
        btnGravar.disabled = false;
        btnGravar.innerHTML = 'Gravar';
    };

    window.alterar = function() {
        abrirPesquisa();
    };

    window.imprimirPDF = async function() {
        await buildResumo();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const conteudo = document.getElementById('resumoContent').innerText;
        doc.setFontSize(16);
        doc.text('CBSaúde Cooperados - Resumo Individual', 14, 22);
        doc.setFontSize(12);
        const linhas = conteudo.split('\n').filter(l => l.trim());
        let y = 40;
        linhas.forEach((linha) => {
            if (y > 280) {
                doc.addPage();
                y = 20;
            }
            doc.text(linha.substring(0, 80), 14, y);
            y += 6;
        });
        doc.save('resumo-individual-cbsaude.pdf');
        mostrarNotificacao('PDF gerado com sucesso!', 'sucesso');
    };

    window.switchTab = async function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tabContent').forEach(c => c.classList.remove('active'));
        document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(tab).classList.add('active');
        if (tab === 'resumo') await buildResumo();
    };

    window.abrirGerenciaFuncionarios = async function() {
        // A permissão já é checada pela função aplicarPermissoes que oculta o botão
        document.getElementById('modalFuncionarios').classList.add('active');
        await renderizarFuncionarios();
    };

    window.fecharGerenciaFuncionarios = function() {
        document.getElementById('modalFuncionarios').classList.remove('active');
    };

    window.adicionarFuncionario = async function() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }

        const btnAdicionar = document.querySelector('button[onclick="adicionarFuncionario()"]');
        const nome = document.getElementById('funcNome').value.trim();
        const user = document.getElementById('funcUser').value.trim().toLowerCase();
        const pass = document.getElementById('funcPass').value.trim();

        // Validações
        if (!nome || !user || !pass) {
            mostrarNotificacao('Preencha todos os campos obrigatórios.', 'erro');
            return;
        }

        if (user.length < 3) {
            mostrarNotificacao('O usuário deve ter pelo menos 3 caracteres.', 'erro');
            return;
        }

        if (pass.length < 4) {
            mostrarNotificacao('A senha deve ter pelo menos 4 caracteres.', 'erro');
            return;
        }

        try {
            btnAdicionar.disabled = true;
            btnAdicionar.innerHTML = 'Adicionando... <span class="spinner"></span>';

            // Verifica se o usuário já existe
            const funcs = await getFuncionarios();
            if (funcs.find(f => f.user.toLowerCase() === user)) {
                mostrarNotificacao('Este nome de usuário já está em uso.', 'erro');
                btnAdicionar.disabled = false;
                btnAdicionar.innerHTML = '<i class="fas fa-plus"></i> Adicionar Funcionário';
                return;
            }
            
            // Permissões padrão para novos funcionários
            const defaultPermissions = {
                canRead: true,           // Pode visualizar cooperados
                canCreate: false,        // Pode criar novos cooperados
                canEdit: false,          // Pode editar cooperados
                canDelete: false,        // Pode deletar cooperados
                canManageUsers: false,   // Pode gerenciar usuários
                canViewSummary: true,    // Pode ver resumo geral
            };

            const newFunc = { 
                nome, 
                user, 
                pass, 
                admin: false,
                permissions: defaultPermissions,
                dataCriacao: new Date().toISOString(),
                criadoPor: window.usuarioLogado.nome
            };

            await addDoc(collection(db, 'funcionarios'), newFunc);
            
            // Limpa os campos e atualiza a lista
            document.getElementById('funcNome').value = '';
            document.getElementById('funcUser').value = '';
            document.getElementById('funcPass').value = '';
            
            // Invalida o cache e atualiza a lista
            window.funcionariosCache = [];
            await renderizarFuncionarios();
            
            mostrarNotificacao('Funcionário adicionado com sucesso!', 'sucesso');

        } catch (error) {
            console.error('Erro ao adicionar funcionário:', error);
            mostrarNotificacao('Erro ao adicionar funcionário. Tente novamente.', 'erro');
        } finally {
            btnAdicionar.disabled = false;
            btnAdicionar.innerHTML = '<i class="fas fa-plus"></i> Adicionar Funcionário';
        }
    };

    // Função para resetar senha do funcionário
    window.resetarSenha = async function(id) {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }

        try {
            const novaSenha = Math.random().toString(36).slice(-8); // Gera senha aleatória
            const userRef = doc(db, 'funcionarios', id);
            await setDoc(userRef, { pass: novaSenha }, { merge: true });
            
            // Mostra a notificação por 10 segundos
            mostrarNotificacao(`Nova senha: ${novaSenha}`, 'info', 10000); 
        } catch (error) {
            console.error('Erro ao resetar senha:', error);
            mostrarNotificacao('Erro ao resetar senha', 'erro');
        }
    };

    window.funcionariosCache = [];

    async function renderizarFuncionarios(filtro = '') {
        try {
            // Atualiza o cache apenas se estiver vazio
            if (window.funcionariosCache.length === 0) {
                const funcs = await getFuncionarios();
                window.funcionariosCache = funcs;
            }

            const div = document.getElementById('listaFuncionarios');
            div.innerHTML = '';

            // Filtra funcionários se houver busca
            const funcsFiltrados = filtro ? 
                window.funcionariosCache.filter(f => 
                    f.nome.toLowerCase().includes(filtro.toLowerCase()) || 
                    f.user.toLowerCase().includes(filtro.toLowerCase())
                ) : window.funcionariosCache;

            if (funcsFiltrados.length === 0) {
                div.innerHTML = '<p class="text-center">Nenhum funcionário encontrado.</p>';
                return;
            }

            funcsFiltrados.forEach(f => {
                const isAdmin = f.admin;
                const permissions = f.permissions || {};
                
                // Template do card de funcionário
                const card = `
                    <div class="funcionario-card" data-id="${f.id}">
                        <div class="funcionario-header">
                            <span class="funcionario-nome">${escapeHTML(f.nome)}</span>
                            <span class="funcionario-tipo">
                                ${isAdmin ? 'Administrador' : 'Operador'}
                            </span>
                        </div>
                        
                        <div>
                            <span style="color: var(--texto-suave);">Login: ${escapeHTML(f.user)}</span>
                        </div>

                        ${!isAdmin ? `
                            <div class="funcionario-permissions">
                                <label class="permission-toggle">
                                    <input type="checkbox" ${permissions.canCreate ? 'checked' : ''} 
                                        onchange="updatePermission('${f.id}', 'canCreate', this.checked)"
                                        ${isAdmin ? 'disabled' : ''}>
                                    <span class="permission-label">Criar</span>
                                </label>
                                <label class="permission-toggle">
                                    <input type="checkbox" ${permissions.canEdit ? 'checked' : ''} 
                                        onchange="updatePermission('${f.id}', 'canEdit', this.checked)"
                                        ${isAdmin ? 'disabled' : ''}>
                                    <span class="permission-label">Editar</span>
                                </label>
                                <label class="permission-toggle">
                                    <input type="checkbox" ${permissions.canDelete ? 'checked' : ''} 
                                        onchange="updatePermission('${f.id}', 'canDelete', this.checked)"
                                        ${isAdmin ? 'disabled' : ''}>
                                    <span class="permission-label">Deletar</span>
                                </label>
                                <label class="permission-toggle">
                                    <input type="checkbox" ${permissions.canViewSummary ? 'checked' : ''} 
                                        onchange="updatePermission('${f.id}', 'canViewSummary', this.checked)"
                                        ${isAdmin ? 'disabled' : ''}>
                                    <span class="permission-label">Ver Resumo</span>
                                </label>
                            </div>
                        ` : ''}
                        
                        <div class="funcionario-actions">
                            ${!isAdmin ? `
                                <button class="btn-top btn-small" onclick="resetarSenha('${f.id}')">
                                    Resetar Senha
                                </button>
                                <button class="btn-top btn-danger btn-small" onclick="removerFuncionario('${f.id}')">
                                    Remover
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                div.insertAdjacentHTML('beforeend', card);
            });
        } catch (error) {
            console.error('Erro ao renderizar funcionários:', error);
            mostrarNotificacao('Erro ao carregar funcionários', 'erro');
        }
    }

    window.filtrarFuncionarios = debounce(function() {
        const filtro = document.getElementById('searchFunc').value;
        renderizarFuncionarios(filtro);
    }, 300);

    window.updatePermission = async function(userId, permission, value) {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        
        try {
            const userRef = doc(db, 'funcionarios', userId);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const permissions = userData.permissions || {};
                permissions[permission] = value;
                
                await setDoc(userRef, { ...userData, permissions }, { merge: true });
                
                // Atualiza o cache local
                const funcIndex = window.funcionariosCache.findIndex(f => f.id === userId);
                if(funcIndex > -1) {
                    window.funcionariosCache[funcIndex].permissions = permissions;
                }
                
                mostrarNotificacao('Permissões atualizadas!', 'sucesso');
            }
        } catch (error) {
            console.error('Erro ao atualizar permissões:', error);
            mostrarNotificacao('Erro ao atualizar permissões', 'erro');
        }
    };

    window.removerFuncionario = async function(id) {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        if (!confirm('Remover funcionário?')) return;
        await deleteDoc(doc(db, 'funcionarios', id));
        
        // Remove do cache
        window.funcionariosCache = window.funcionariosCache.filter(f => f.id !== id);
        await renderizarFuncionarios(); // Re-renderiza a partir do cache
        
        mostrarNotificacao('Funcionário removido', 'sucesso');
    };

    // Função de filtro simplificada para busca por nome ou CPF
    function filtrarModal() {
        if (!cacheReady) return; // Proteção caso o cache não esteja pronto
        
        const searchInput = document.getElementById('searchModalInput');
        const termoBusca = removerAcentos(searchInput.value.toLowerCase().trim());
        const div = document.getElementById('modalResults');
        div.innerHTML = '';
        
        // Se não houver termo de busca, mostra todos os resultados
        if (!termoBusca) {
            cooperadosCache.forEach(a => mostrarResultado(a, div));
            return;
        }
        
        // Filtra os cooperados que correspondem à busca
        const resultados = cooperadosCache.filter(a => {
            const nome = removerAcentos((a.nome || '').toLowerCase());
            const cpf = (a.cpf || '').replace(/\D/g, '');
            return nome.includes(termoBusca) || cpf.includes(termoBusca);
        });

        // Mostra mensagem se não encontrar resultados
        if (resultados.length === 0) {
            div.innerHTML = '<p>Nenhum cooperado encontrado.</p>';
            return;
        }

        // Mostra os resultados encontrados
        resultados.forEach(a => mostrarResultado(a, div));
    }

    // Função auxiliar para mostrar um resultado da pesquisa
    function mostrarResultado(a, div) {
        // CORREÇÃO BUG: Checa permissão de delete do usuário logado
        const canDelete = window.usuarioLogado?.admin || window.usuarioLogado?.permissions?.canDelete;
        const removeBtn = canDelete ? 
            `<button class="btn-top btn-danger btn-small" onclick="removerCooperado('${a.id}', event)">Remover</button>` : '';

        // Mapa para os nomes amigáveis (baseado no HTML)
        const statusMap = {
            'ATIVO': 'Ativo',
            'INATIVO': 'Inativo',
            'APOSENTADO': 'Aposentado',
            'FALECIDO': 'Falecido',
            'PENSIONISTA': 'Pensionista',
            'REFORMADO': 'Reformado',
            'FUNCIONARIO_CIVIL': 'Funcionário Civil',
            'FUNCIONARIO_CIVIL_APOSENTADO': 'Funcionário Civil Aposentado',
            'EX_BOMBEIRO': 'Ex-Bombeiro'
        };

        const statusNome = statusMap[a.statusParentesco] || a.statusParentesco || '—';
        // A classe CSS é o valor em minúsculo
        const statusClass = a.statusParentesco ? `status-${a.statusParentesco.toLowerCase()}` : '';

        // MELHORIA ESTÉTICA: Aplicado flexbox ao .list-item
        div.insertAdjacentHTML('beforeend', `
            <div class="list-item" style="display:flex; justify-content:space-between; align-items:center;">
                <div onclick="editAssociado('${a.id}')" style="flex: 1; cursor: pointer; padding-right: 1rem;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap;">
                        <span style="font-size: 1.1em; font-weight: 600;">
                            ${escapeHTML(a.nome || '')}
                        </span>
                        <span class="${statusClass}">
                            ${escapeHTML(statusNome)}
                        </span>
                    </div>
                    <div style="color: var(--texto-suave); font-size: 0.9em;">
                        CPF: ${formatarCPF(a.cpf || '—')} 
                        ${a.pasta ? ` | Pasta: ${a.pasta}` : ''}
                    </div>
                </div>
                ${removeBtn}
            </div>
        `);
    }

    // LIMPEZA: Removidas funções 'renderizarItemPesquisa', 'destacarTermos', 'getTipoCooperadoLabel'

    window.debouncedFilter = debounce(filtrarModal, 300);

    window.removerCooperado = async function(id, event) {
        event.stopPropagation();
        
        // Permissão checada no botão, mas checamos de novo por segurança
        const canDelete = window.usuarioLogado?.admin || window.usuarioLogado?.permissions?.canDelete;
        if (!canDelete) {
            mostrarNotificacao('Você não tem permissão para deletar.', 'erro');
            return;
        }

        if (!confirm('Confirma remoção deste cooperado?')) return;
        
        const item = event.target.closest('.list-item');
        if (item) item.classList.add('fade-out');
        
        try {
            await deleteDoc(doc(db, 'associados', id));
            cacheReady = false; // Invalida o cache
            
            setTimeout(() => {
                filtrarModal(); // Re-filtra a lista local
                mostrarNotificacao('Cooperado removido', 'sucesso');
            }, 400);
        } catch (error) {
             console.error('Erro ao remover:', error);
             mostrarNotificacao('Erro ao remover cooperado.', 'erro');
             if(item) item.classList.remove('fade-out');
        }
    };

    window.addDependente = function() {
        window.deps.push({ nome: '', parent: '', nasc: '', cpf: '', plano: '' });
        renderDeps();
    };

    window.renderDeps = function() {
        const div = document.getElementById('depsList');
        div.innerHTML = '';
        const canEdit = window.usuarioLogado?.admin || window.usuarioLogado?.permissions?.canEdit;

        window.deps.forEach((d, i) => {
            const removeBtn = canEdit ? 
                `<div class="col"><button type="button" class="btn-top btn-danger" onclick="window.deps.splice(${i},1); renderDeps()">Remover</button></div>` : '';
            
            div.insertAdjacentHTML('beforeend', `
                <div class="row" style="align-items:end;margin-bottom:1rem;padding:1rem;background:var(--azul-claro);border-radius:8px;">
                    <div class="col"><label>Nome</label><input value="${escapeHTML(d.nome)}" onchange="window.deps[${i}].nome=this.value" ${!canEdit ? 'readonly' : ''}></div>
                    <div class="col"><label>Parentesco</label><input value="${escapeHTML(d.parent)}" onchange="window.deps[${i}].parent=this.value" ${!canEdit ? 'readonly' : ''}></div>
                    <div class="col"><label>Nasc.</label><input type="date" value="${d.nasc}" onchange="window.deps[${i}].nasc=this.value" ${!canEdit ? 'readonly' : ''}></div>
                    <div class="col"><label>CPF</label><input value="${escapeHTML(d.cpf)}" onchange="window.deps[${i}].cpf=this.value" ${!canEdit ? 'readonly' : ''}></div>
                    <div class="col"><label>Plano</label>
                        <select onchange="window.deps[${i}].plano=this.value" ${!canEdit ? 'disabled' : ''}>
                            <option value="">Nenhum</option>
                            <option value="224" ${d.plano==='224'?'selected':''}>Alfa (224)</option>
                            <option value="226" ${d.plano==='226'?'selected':''}>Bravo (226)</option>
                            <option value="228" ${d.plano==='228'?'selected':''}>Delta (228)</option>
                        </select>
                    </div>
                    ${removeBtn}
                </div>
            `);
        });
    };

    async function buildResumo() {
        const r = document.getElementById('resumoContent');
        r.innerHTML = '';

        const editId = document.getElementById('editIndex').value;
        if (!editId) {
            r.innerHTML = '<p>Selecione ou crie um cooperado para ver o resumo.</p>';
            return;
        }
        
        try {
            const docSnap = await getDoc(doc(db, 'associados', editId));
            if (!docSnap.exists()) {
                r.innerHTML = '<p>Cooperado não encontrado.</p>';
                return;
            }
            const a = docSnap.data();

            const nome = a.nome || '—';
            const cpf = a.cpf || '—';
            const planoTit = a.plano;
            const valorTit = valorPlano(planoTit);
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Titular</h3>
                    <div class="resumo-line"><span>Nome:</span><span>${escapeHTML(nome)}</span></div>
                    <div class="resumo-line"><span>CPF:</span><span>${cpf}</span></div>
                    <div class="resumo-line"><span>Plano:</span><span>${planoTit || '—'} - R$ ${valorTit.toFixed(2)}</span></div>
                </div>
            `);

            let total = valorTit;
            if (a.dependentes && a.dependentes.length) {
                r.insertAdjacentHTML('beforeend', '<h3>Dependentes</h3>');
                a.dependentes.forEach(d => {
                    const v = valorPlano(d.plano);
                    total += v;
                    r.insertAdjacentHTML('beforeend', `
                        <div class="resumo-line">
                            <span>${escapeHTML(d.nome || '—')} (${escapeHTML(d.parent || '—')}) - CPF: ${d.cpf || '—'} - Plano: ${d.plano || '—'}</span>
                            <span>R$ ${v.toFixed(2)}</span>
                        </div>
                    `);
                });
            }

            const conj = a.conjuge || {};
            const conjNome = conj.nome || '';
            const conjCpf = conj.cpf || '—';
            const conjNasc = conj.nasc || '—';
            const conjPlano = conj.plano;
            const conjValor = valorPlano(conjPlano);
            if (conjNome) {
                r.insertAdjacentHTML('beforeend', '<h3>Cônjuge</h3>');
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-line">
                        <span>${escapeHTML(conjNome)} - CPF: ${conjCpf} - Nasc: ${conjNasc} - Plano: ${conjPlano || '—'}</span>
                        <span>R$ ${conjValor.toFixed(2)}</span>
                    </div>
                `);
                total += conjValor;
            }

            let months = 0;
            let totalPaid = 0;
            if (a.dataAssociacao) {
                const joinDate = new Date(a.dataAssociacao);
                const now = new Date();
                months = (now.getFullYear() - joinDate.getFullYear()) * 12 + (now.getMonth() - joinDate.getMonth());
                if (now.getDate() < joinDate.getDate()) months--;
                months = Math.max(months, 0);
                totalPaid = months * total;
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-block">
                        <h3>Histórico</h3>
                        <div class="resumo-line"><span>Data de Associação:</span><span>${a.dataAssociacao}</span></div>
                        <div class="resumo-line"><span>Meses Cooperado:</span><span>${months}</span></div>
                        <div class="resumo-line"><span>Total Pago (estimado):</span><span>R$ ${totalPaid.toFixed(2)}</span></div>
                    </div>
                `);
            } else {
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-block">
                        <h3>Histórico</h3>
                        <p>Data de Associação não informada.</p>
                    </div>
                `);
            }

            let pend = [];
            if (!a.cpf) pend.push('CPF do titular faltando');
            if (!a.nasc) pend.push('Data de nascimento do titular faltando');
            a.dependentes?.forEach((d, i) => {
                if (d.nome) {
                    if (!d.cpf) pend.push(`CPF do dependente ${i+1} (${escapeHTML(d.nome)}) faltando`);
                    if (!d.nasc) pend.push(`Data de nascimento do dependente ${i+1} (${escapeHTML(d.nome)}) faltando`);
                }
            });
            if (conjNome) {
                if (!conj.cpf) pend.push('CPF do cônjuge faltando');
                if (!conj.nasc) pend.push('Data de nascimento do cônjuge faltando');
            }
            if (pend.length) {
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-block">
                        <h3>Pendências</h3>
                        <ul>${pend.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                `);
            }

            r.insertAdjacentHTML('beforeend', `
                <div class="total">Total Mensal: R$ ${total.toFixed(2)}</div>
            `);
        } catch(e) {
            console.error(e);
            r.innerHTML = '<p>Erro ao carregar resumo.</p>';
        }
    }

    window.abrirResumoGeral = async function() {
        // Permissão já checada pelo botão
        document.getElementById('modalResumoGeral').classList.add('active');
        await buildResumoGeral();
    };

    window.fecharResumoGeral = function() {
        document.getElementById('modalResumoGeral').classList.remove('active');
    };

    async function buildResumoGeral() {
        const r = document.getElementById('resumoGeralContent');
        r.innerHTML = '<h2 class="resumo-titulo">Resumo Geral - CBSaúde Cooperados</h2>';

        try {
            const lista = await getData();
            let totalGeral = 0;
            let countCooperados = lista.length;
            let totalDependentes = 0;
            let totalConjuges = 0;

            // Contagem e cálculos
            lista.forEach(a => {
                // Contagem de dependentes e cônjuges
                if (a.dependentes) totalDependentes += a.dependentes.length;
                if (a.conjuge?.nome) totalConjuges++;

                // Cálculo financeiro
                let totalIndividual = valorPlano(a.plano);
                if (a.dependentes) {
                    a.dependentes.forEach(d => totalIndividual += valorPlano(d.plano));
                }
                if (a.conjuge?.nome) totalIndividual += valorPlano(a.conjuge.plano);
                totalGeral += totalIndividual;
            });

            // Exibição do resumo
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-cards">
                    <div class="resumo-card">
                        <h3>Total de Cooperados</h3>
                        <div class="numero">${countCooperados}</div>
                    </div>
                    <div class="resumo-card">
                        <h3>Total de Dependentes</h3>
                        <div class="numero">${totalDependentes}</div>
                    </div>
                    <div class="resumo-card">
                        <h3>Total de Cônjuges</h3>
                        <div class="numero">${totalConjuges}</div>
                    </div>
                    <div class="resumo-card destaque">
                        <h3>Valor Total Mensal</h3>
                        <div class="numero">R$ ${totalGeral.toFixed(2)}</div>
                    </div>
                </div>
            `);

        } catch (erro) {
            console.error('Erro ao gerar resumo:', erro);
            r.innerHTML += '<p class="erro-mensagem">Erro ao carregar dados. Tente novamente.</p>';
        }
    }
    function resetAll() {
        document.getElementById('associadoForm').reset();
        document.getElementById('editIndex').value = '';
        window.deps = [];
        renderDeps();
    }

    window.editAssociado = async function(id) {
        try {
            const docSnap = await getDoc(doc(db, 'associados', id));
            if (docSnap.exists()) {
                const a = docSnap.data();
                document.getElementById('editIndex').value = id;

                // Preenche os campos básicos
                Object.keys(a).forEach(k => {
                    if (k !== 'id' && k !== 'dependentes' && k !== 'conjuge') {
                        const el = document.getElementById(k);
                        if (el) el.value = a[k] || '';
                    }
                });
                
                // Garante que o status seja preenchido corretamente
                if (a.statusParentesco) {
                    document.getElementById('statusParentesco').value = a.statusParentesco;
                }

                window.deps = a.dependentes || [];
                renderDeps();
                const conj = a.conjuge || {};
                document.getElementById('conjNome').value = conj.nome || '';
                document.getElementById('conjCpf').value = conj.cpf || '';
                document.getElementById('conjNasc').value = conj.nasc || '';
                document.getElementById('conjPlano').value = conj.plano || '';

                switchTab('dados');
                fecharPesquisa();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                mostrarNotificacao('Cooperado carregado para edição', 'info');
            }
        } catch(e) {
            console.error('Erro ao editar:', e);
            mostrarNotificacao('Erro ao carregar dados do cooperado', 'erro');
        }
    };

    window.saveAll = async function(event) {
        event.preventDefault();
        const form = document.getElementById('associadoForm');
        const editId = document.getElementById('editIndex').value;
        
        const associado = {
            nome: form.nome.value.trim(),
            cpf: form.cpf.value,
            pasta: form.pasta.value,
            matricula: form.matricula.value,
            nasc: form.nasc.value,
            dataAssociacao: form.dataAssociacao.value,
            sexo: form.sexo.value,
            civil: form.civil.value,
            endereco: form.endereco.value,
            numero: form.numero.value,
            bairro: form.bairro.value,
            municipio: form.municipio.value,
            estado: form.estado.value,
            cep: form.cep.value,
            telefone: form.telefone.value,
            email: form.email.value,
            plano: form.plano.value,
            obs: form.obs.value,
            dependentes: window.deps,
            conjuge: {
                nome: form.conjNome.value,
                cpf: form.conjCpf.value,
                nasc: form.conjNasc.value,
                plano: form.conjPlano.value
            },
            // CORREÇÃO BUG: Adicionado o campo que faltava
            statusParentesco: form.statusParentesco.value 
        };

        if (!associado.nome || !associado.cpf) {
            mostrarNotificacao('Nome e CPF são obrigatórios para o titular.', 'erro');
            return;
        }

        if (associado.cpf && !validarCPF(associado.cpf)) {
            mostrarNotificacao('CPF do titular é inválido.', 'erro');
            return;
        }
        
        if (!associado.statusParentesco) {
             mostrarNotificacao('O campo "Status/Tipo de Cooperado" é obrigatório.', 'erro');
             return;
        }

        const conj = associado.conjuge;
        if (conj.cpf && !validarCPF(conj.cpf)) {
            mostrarNotificacao('CPF do cônjuge é inválido.', 'erro');
            return;
        }

        try {
            if (editId) {
                await setDoc(doc(db, 'associados', editId), associado);
            } else {
                const docRef = await addDoc(collection(db, 'associados'), associado);
                document.getElementById('editIndex').value = docRef.id; // Define o ID para o novo doc
            }
            cacheReady = false; // Invalida o cache
            mostrarNotificacao('Dados salvos com sucesso!', 'sucesso');
            // Não reseta mais o form, permite continuar editando
            // resetAll(); 
        } catch (error) {
            console.error('Erro ao salvar:', error);
            mostrarNotificacao('Erro ao salvar os dados. Tente novamente.', 'erro');
        }
    };

    async function initAdmin() {
        try {
            const funcs = await getFuncionarios();
            if (!funcs.find(f => f.user === 'admin')) {
                await addDoc(collection(db, 'funcionarios'), { nome: 'Administrador', user: 'admin', pass: '1234', admin: true });
            }
        } catch(e) {
            console.error("Erro ao inicializar admin:", e);
        }
    }

    window.deps = [];

    window.onload = async () => {
        // LIMPEZA: Removida chamada para 'carregarTiposCooperados()'
        await initAdmin();
        document.getElementById('userInput').focus();

        document.getElementById('cpf').addEventListener('blur', function() {
            this.value = formatarCPF(this.value);
            if (this.value && !validarCPF(this.value)) {
                mostrarNotificacao('CPF inválido!', 'erro');
                this.focus();
            }
        });
        document.getElementById('telefone').addEventListener('blur', function() {
            this.value = formatarTelefone(this.value);
        });
        document.getElementById('cep').addEventListener('blur', function() {
            this.value = formatarCEP(this.value);
        });
        document.getElementById('conjCpf').addEventListener('blur', function() {
            this.value = formatarCPF(this.value);
            if (this.value && !validarCPF(this.value)) {
                mostrarNotificacao('CPF do cônjuge inválido!', 'erro');
                this.focus();
            }
        });
        
        document.getElementById('passInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doLogin();
            }
        });
    };
</script>
</body>
</html>