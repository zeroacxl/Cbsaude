<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CBSaúde Cooperados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --azul: #2563eb;
            --azul-escuro: #1e40af;
            --azul-claro: #eff6ff;
            --branco: #ffffff;
            --cinza: #f8fafc;
            --texto: #1e293b;
            --texto-suave: #64748b;
            --borda: #e2e8f0;
            --erro: #ef4444;
            --sucesso: #22c55e;
            --aviso: #f59e0b;
            --transicao: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sombra-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sombra-inset: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            --sombra-foco: 0 0 0 3px rgba(37, 99, 235, 0.25);
            --gradient-bg: linear-gradient(135deg, var(--azul-claro), var(--branco));
        }
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Roboto, sans-serif;
        }
        body {
            margin: 0;
            background: var(--gradient-bg);
            color: var(--texto);
            font-size: clamp(14px, 2.5vw, 16px);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            transition: background var(--transicao);
        }
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(145deg, var(--azul-claro), var(--branco));
            box-shadow: var(--sombra);
            padding: .6rem .8rem;
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.5s ease-out;
        }
        .top-bar h1 {
            margin: 0;
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: var(--azul-escuro);
            text-shadow: 1px 1px 2px rgba(0,0,0,.1);
            transition: color var(--transicao);
        }
        .top-bar h1:hover {
            color: var(--azul);
        }
        .btn-top {
            background: var(--azul);
            color: #fff;
            border: none;
            padding: .7rem 1.2rem;
            border-radius: 8px;
            box-shadow: var(--sombra);
            cursor: pointer;
            transition: all var(--transicao);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .btn-top:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-top:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--sombra-hover);
            background: var(--azul-escuro);
        }

        .btn-top:active:not(:disabled) {
            transform: translateY(1px) scale(0.98);
            box-shadow: var(--sombra);
        }

        .btn-top::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease-in-out;
        }

        .btn-top:hover::after {
            transform: translateX(100%);
        }
        .btn-top.imprimir {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }
        .btn-top.sair {
            background: linear-gradient(145deg, #c62828, #8e0000);
            margin-left: auto;
        }
        .tabs-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            background: var(--branco);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
        }
        .tabs {
            display: flex;
            gap: .3rem;
            min-width: max-content;
            transition: all var(--transicao);
        }
        .tab {
            padding: .6rem 1rem;
            background: linear-gradient(145deg, var(--branco), var(--azul-claro));
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            box-shadow: var(--sombra-inset);
            white-space: nowrap;
            transition: all var(--transicao);
        }
        .tab:hover {
            transform: translateY(-2px);
            background: var(--azul-claro);
        }
        .tab.active {
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            transform: translateY(0);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: .8rem;
            animation: fadeIn 0.6s ease-in-out;
        }
        .card {
            background: var(--branco);
            border-radius: 12px;
            box-shadow: var(--sombra);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: scaleIn 0.4s ease-out;
            transition: all var(--transicao);
        }

        .card:hover {
            box-shadow: var(--sombra-hover);
            transform: translateY(-4px) scale(1.01);
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: .8rem;
            transition: all var(--transicao);
            margin-bottom: 0.8rem; /* Added margin between rows */
        }
        .col {
            flex: 1 1 260px;
            display: flex;
            flex-direction: column;
            transition: transform var(--transicao);
        }
        .col:hover {
            transform: translateY(-2px);
        }
        label {
            margin-bottom: .3rem;
            font-weight: 600;
            color: var(--azul-escuro);
            transition: color var(--transicao);
        }
        input, select, textarea {
            width: 100%;
            padding: .7rem .8rem;
            font-size: 1em;
            color: var(--texto);
            background: var(--branco);
            border: 1px solid var(--borda);
            border-radius: 8px;
            box-shadow: var(--sombra-inset);
            transition: all var(--transicao);
        }

        input:hover, select:hover, textarea:hover {
            border-color: var(--azul);
            transform: scale(1.02);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--azul);
            box-shadow: var(--sombra-foco);
            transform: scale(1.02);
        }

        input:disabled, select:disabled, textarea:disabled {
            background: var(--cinza);
            cursor: not-allowed;
            opacity: 0.7;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .hidden {
            display: none;
        }
        .tabContent {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            transition: opacity var(--transicao), transform var(--transicao);
        }
        .tabContent.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
                filter: blur(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.4s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding: 4vh 1rem;
            z-index: 200;
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--branco);
            border-radius: 10px;
            box-shadow: var(--sombra-hover);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: scaleIn 0.4s ease-out;
        }
        .modal-header {
            padding: .8rem 1rem;
            background: linear-gradient(145deg, var(--azul), var(--azul-escuro));
            color: #fff;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .search-input {
            width: 100%;
            padding: .7rem;
            font-size: 1.1em;
            border: 2px solid var(--azul-claro);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all var(--transicao);
        }
        .search-input:focus {
            border-color: var(--azul);
            transform: scale(1.02);
        }
        .list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--borda);
            cursor: pointer;
            transition: all var(--transicao);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--branco);
            box-shadow: var(--sombra);
        }

        .list-item:hover {
            background: var(--azul-claro);
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--sombra-hover);
        }

        .list-item:active {
            transform: translateY(2px) scale(0.98);
        }
        .list-item span {
            display: block;
            font-weight: 600;
        }
        .list-item small {
            color: #555;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .95em;
        }
        th, td {
            padding: .6rem .5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: var(--azul-claro);
            color: var(--azul-escuro);
        }
        tr:hover {
            background: #f1f8ff;
            transition: background var(--transicao);
        }
        .actions {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: .4rem .6rem;
            font-size: .85em;
        }
        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333) !important;
        }
        .resumo-block {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            animation: fadeIn 0.5s;
        }
        .resumo-line {
            display: flex;
            justify-content: space-between;
            padding: .5rem 0;
            border-bottom: 1px dotted #ddd;
            transition: background var(--transicao);
        }
        .resumo-line:hover {
            background: var(--azul-claro);
        }
        .total {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid var(--azul);
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            color: var(--azul-escuro);
            animation: scaleIn 0.4s;
        }
        .fade-out {
            animation: fadeOut .4s forwards;
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(30px);
                filter: blur(5px);
            }
        }

        .notificacao {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            box-shadow: var(--sombra-hover);
            z-index: 1000;
            min-width: 200px;
            text-align: center;
            animation: slideIn 0.4s ease-out, fadeOut 0.4s 2.6s forwards;
        }

        .notificacao.sucesso {
            background: var(--sucesso);
        }

        .notificacao.erro {
            background: var(--erro);
        }

        .notificacao.info {
            background: var(--azul);
        }

        .notificacao.aviso {
            background: var(--aviso);
        }

        .login-box h2 {
            color: var(--azul-escuro);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-box label {
            margin-top: 1rem;
        }

        .login-box .btn-top {
            width: 100%;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>

<section id="loginScreen" class="container login-box">
    <div class="card" style="max-width:400px;margin:10vh auto; animation: scaleIn 0.6s ease-out;">
        <h2>CBSaúde - Login</h2>
        <label>Usuário</label>
        <input id="userInput" type="text" placeholder="admin">
        <label>Senha</label>
        <input id="passInput" type="password" placeholder="1234">
        <button class="btn-top" onclick="doLogin()">Entrar</button>
        <p style="color:#666;font-size:.8rem;margin-top:.8rem;text-align:center;">Login master: admin / 1234</p>
    </div>
</section>

<section id="mainApp" class="hidden">
    <div class="top-bar">
        <h1>CBSaúde Cooperados</h1>
        <button class="btn-top" onclick="abrirPesquisa()">Procurar</button>
        <button class="btn-top" id="btnAlterar" onclick="alterar()">Alterar</button>
        <button class="btn-top" id="btnGravar" onclick="gravar()">Gravar</button>
        <button class="btn-top" id="btnNovo" onclick="novo()">Novo</button>
        <button class="btn-top imprimir" onclick="imprimirPDF()">PDF</button>
        <button class="btn-top hidden" onclick="abrirResumoGeral()" id="btnResumoGeral">Resumo Geral</button>
        <button class="btn-top hidden" onclick="abrirGerenciaFuncionarios()" id="btnGerencia">Gerenciar Funcionários</button>
        <button class="btn-top hidden" onclick="abrirImportarDados()" id="btnImportar">Importar Dados</button>
        <button class="btn-top sair" onclick="doLogout()">Sair</button>
    </div>

    <div class="container">
        <div class="card">
            <form id="associadoForm" onsubmit="saveAll(event)">
                <input id="editIndex" type="hidden">

                <div class="tabs-wrapper">
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('dados')">Dados Pessoais</div>
                        <div class="tab" onclick="switchTab('dependentes')">Dependentes</div>
                        <div class="tab" onclick="switchTab('conjuge')">Cônjuge</div>
                        <div class="tab" onclick="switchTab('resumo')">Resumo Individual</div>
                    </div>
                </div>

                <div id="dados" class="tabContent active">
                    <h3>Dados Pessoais</h3>
                    <div class="row">
                        <div class="col"><label>Nome *</label><input id="nome" required></div>
                        <div class="col"><label>CPF *</label><input id="cpf" required></div>
                        <div class="col"><label>Nº da Pasta</label><input id="pasta"></div>
                        <div class="col"><label>Matrícula</label><input id="matricula"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Data Nasc.</label><input id="nasc" type="date"></div>
                        <div class="col"><label>Data de Associação</label><input id="dataAssociacao" type="date"></div>
                        <div class="col"><label>Sexo</label>
                            <select id="sexo">
                                <option value="">Selecione</option>
                                <option>Masculino</option>
                                <option>Feminino</option>
                                <option>Não-binário</option>
                                <option>Outro</option>
                            </select>
                        </div>
                        <div class="col"><label>Estado Civil</label>
                            <select id="civil">
                                <option value="">Selecione</option>
                                <option>Solteiro(a)</option><option>Casado(a)</option><option>Divorciado(a)</option><option>Viúvo(a)</option><option>União Estável</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Endereço</label><input id="endereco"></div>
                        <div class="col"><label>Número</label><input id="numero"></div>
                        <div class="col"><label>Bairro</label><input id="bairro"></div>
                        <div class="col"><label>Município</label><input id="municipio"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Estado</label><input id="estado" maxlength="2"></div>
                        <div class="col"><label>CEP</label><input id="cep"></div>
                        <div class="col"><label>Telefone</label><input id="telefone"></div>
                        <div class="col"><label>E-mail</label><input id="email" type="email"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Plano</label>
                            <select id="plano">
                                <option value="">Nenhum</option>
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Observações</label><textarea id="obs"></textarea></div>
                    </div>
                    <small>* Campos obrigatórios apenas para o titular. Dependentes e cônjuge podem ser salvos parcialmente.</small>
                </div>

                <div id="dependentes" class="tabContent">
                    <h3>Dependentes</h3>
                    <div id="depsList"></div>
                    <button type="button" class="btn-top" id="btnAddDependente" onclick="addDependente()">+ Dependente</button>
                </div>

                <div id="conjuge" class="tabContent">
                    <h3>Cônjuge</h3>
                    <div class="row">
                        <div class="col"><label>Nome</label><input id="conjNome"></div>
                        <div class="col"><label>CPF</label><input id="conjCpf"></div>
                        <div class="col"><label>Data Nasc.</label><input id="conjNasc" type="date"></div>
                        <div class="col"><label>Plano</label>
                            <select id="conjPlano">
                                <option value="">Nenhum</option>
                                <option value="224">Alfa (224)</option>
                                <option value="226">Bravo (226)</option>
                                <option value="228">Delta (228)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="resumo" class="tabContent">
                    <h3>Resumo Individual</h3>
                    <div id="resumoContent"></div>
                </div>
            </form>
        </div>
    </div>
</section>

<div id="modalPesquisa" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Pesquisar Cooperado</span>
            <button class="btn-top btn-danger" onclick="fecharPesquisa()">✖</button>
        </div>
        <div class="modal-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <input class="search-input" id="searchModalInput" placeholder="Digite nome ou CPF..." onkeyup="debouncedFilter()" onkeypress="handleSearchEnter(event)" style="flex: 1;">
                <button class="btn-top" onclick="filtrarModal()">Pesquisar</button>
            </div>
            <div id="modalResults" style="max-height: 50vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="modalFuncionarios" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Gerenciar Funcionários</span>
            <button class="btn-top btn-danger" onclick="fecharGerenciaFuncionarios()">✖</button>
        </div>
        <div class="modal-body">
            <h4>Adicionar / Editar Funcionário</h4>
            <input type="hidden" id="funcEditId">
            <div class="row">
                <div class="col"><label>Nome</label><input id="funcNome"></div>
                <div class="col"><label>Usuário</label><input id="funcUser"></div>
                <div class="col"><label>Senha</label><input id="funcPass" type="password"></div>
            </div>
            <div class="row">
                <div class="col" style="flex-direction: row; align-items: center; gap: 5px;"><input type="checkbox" id="funcAdmin" style="width: auto;"><label>Admin?</label></div>
                <div class="col" style="flex-direction: row; align-items: center; gap: 5px;"><input type="checkbox" id="funcReadOnly" style="width: auto;"><label>Somente Leitura?</label></div>
                <div class="col" style="flex-direction: row; align-items: center; gap: 5px;"><input type="checkbox" id="funcCanImport" style="width: auto;"><label>Pode Importar?</label></div>
                <div class="col" style="flex-direction: row; align-items: center; gap: 5px;"><input type="checkbox" id="funcCanDelete" style="width: auto;"><label>Pode Excluir?</label></div>
            </div>
            <button class="btn-top" id="btnSalvarFunc" onclick="adicionarOuAtualizarFuncionario()">Adicionar</button>
            <button class="btn-top btn-danger" onclick="resetFuncForm()">Cancelar Edição</button>
            <hr style="margin: 1.5rem 0;">
            <h4>Funcionários Cadastrados</h4>
            <div id="listaFuncionarios" style="max-height: 40vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="modalImportar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Importar Dados</span>
            <button class="btn-top btn-danger" onclick="fecharImportarDados()">✖</button>
        </div>
        <div class="modal-body">
            <h4>Importar Cooperados (JSON ou CSV)</h4>
            <p>Selecione um arquivo .json (no formato específico do Excel convertido) ou .csv.</p>
            <input type="file" id="importFile" accept=".json,.csv">
            <button class="btn-top" onclick="importarDados()">Importar</button>
        </div>
    </div>
</div>

<div id="modalResumoGeral" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <span>Resumo Geral</span>
            <button class="btn-top btn-danger" onclick="fecharResumoGeral()">✖</button>
        </div>
        <div class="modal-body" id="resumoGeralContent" style="max-height: 70vh; overflow-y: auto;">
            </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, getDoc, query, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Sua configuração do Firebase (MANTENHA A SUA ORIGINAL)
    const firebaseConfig = {
        apiKey: "AIzaSyBexxAzdyVtthakeOVfTf-PxnlQ5rNynRQ",
        authDomain: "cbsaudecooperados.firebaseapp.com",
        projectId: "cbsaudecooperados",
        storageBucket: "cbsaudecooperados.appspot.com", // Verifique se este é o correto
        messagingSenderId: "558244165893",
        appId: "1:558244165893:web:2e10e9560c896f43e6df6c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- FUNÇÕES UTILITÁRIAS ----------
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(str); // Convert to string before setting textContent
        return div.innerHTML;
    }

    function formatarCPF(cpf) {
        if (!cpf) return '';
        cpf = String(cpf).replace(/\D/g, ''); // Ensure string and remove non-digits
        if (cpf.length !== 11) return cpf; // Return raw if not 11 digits
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatarTelefone(tel) {
        if (!tel) return '';
        tel = String(tel).replace(/\D/g, '');
        if (tel.length === 11) {
            return tel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (tel.length === 10) {
            return tel.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        }
        return tel; // Return raw if length is different
    }

    function formatarCEP(cep) {
        if (!cep) return '';
        cep = String(cep).replace(/\D/g, '');
        if (cep.length !== 8) return cep;
        return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }

    function cleanCPF(cpf) {
        if (cpf === null || cpf === undefined) return '';
        return String(cpf).replace(/\D/g, ''); // Remove non-digits
    }

    function validarCPF(cpf) {
        cpf = cleanCPF(cpf); // Use the cleaned CPF

        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
            return false;
        }

        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf.charAt(i)) * (10 - i);
        }

        let resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(9))) return false;

        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf.charAt(i)) * (11 - i);
        }

        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(10))) return false;

        return true;
    }

    // Function to get data from Firestore
    async function getData() {
        try {
            const q = query(collection(db, 'associados'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error("Erro ao buscar associados:", e);
            mostrarNotificacao('Erro ao buscar dados dos cooperados.', 'erro');
            return [];
        }
    }

    async function getFuncionarios() {
        try {
            const q = query(collection(db, 'funcionarios'), orderBy('nome'));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error("Erro ao buscar funcionários:", e);
            mostrarNotificacao('Erro ao buscar dados dos funcionários.', 'erro');
            return [];
        }
    }

    // ---------- FUNÇÕES GLOBAIS (BOTÕES E NAVEGAÇÃO) ----------
    function mostrarNotificacao(mensagem, tipo = 'info') {
        // Remove existing notifications first
        document.querySelectorAll('.notificacao').forEach(n => n.remove());

        const div = document.createElement('div');
        div.className = `notificacao ${tipo}`;
        div.textContent = mensagem;
        document.body.appendChild(div);

        // Animate in
        requestAnimationFrame(() => {
            div.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            div.style.opacity = '1';
            div.style.transform = 'translateX(0)';
        });
        div.style.opacity = '0';
        div.style.transform = 'translateX(100%)';


        setTimeout(() => {
            div.style.opacity = '0';
            div.style.transform = 'translateX(100%)';
            setTimeout(() => div.remove(), 400); // Remove after fade out
        }, 3000); // Notification stays for 3 seconds
    }


    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function removerAcentos(str) {
        if (!str) return '';
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function valorPlano(cod) {
        if (!cod) return 0;
        switch (String(cod)) {
            case '224': return 20;  // Alfa
            case '226': return 115; // Bravo
            case '228': return 155; // Delta
            default: return 0;
        }
    }

    function nomePlano(cod) {
         if (!cod) return 'Nenhum';
         switch (String(cod)) {
            case '224': return 'Alfa';
            case '226': return 'Bravo';
            case '228': return 'Delta';
            default: return 'Desconhecido';
         }
    }

    // Convert dd/mm/yyyy to yyyy-mm-dd for date inputs
    function formatToISODate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return '';
        const parts = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (parts) {
            // parts[0] is the full match, [1] is day, [2] is month, [3] is year
            return `${parts[3]}-${parts[2]}-${parts[1]}`;
        }
        // If it's already in ISO format or another format, return as is (input will handle)
        return dateStr;
    }

    // Convert yyyy-mm-dd from date input back to dd/mm/yyyy for display/storage consistency if needed
    function formatToDisplayDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return '';
        const parts = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (parts) {
            // parts[0] is the full match, [1] is year, [2] is month, [3] is day
            return `${parts[3]}/${parts[2]}/${parts[1]}`;
        }
        return dateStr; // Return original if not in ISO format
    }

    // Global state
    window.usuarioLogado = null;
    window.associadosList = null; // Cache for search modal
    window.deps = []; // Current dependents being edited/added
    window.canDelete = false; // Permission flag

    window.doLogin = async function() {
        const btnLogin = document.querySelector('button[onclick="doLogin()"]');
        const u = document.getElementById('userInput').value.trim();
        const p = document.getElementById('passInput').value.trim();

        if (!u || !p) {
            mostrarNotificacao('Preencha todos os campos', 'erro');
            return;
        }

        btnLogin.disabled = true;
        btnLogin.textContent = 'Entrando...';

        try {
            const funcs = await getFuncionarios();
            const user = funcs.find(f => f.user === u && f.pass === p);

            if (user) {
                window.usuarioLogado = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('btnGerencia').classList.toggle('hidden', !user.admin);
                document.getElementById('btnResumoGeral').classList.toggle('hidden', !user.admin);
                document.getElementById('btnImportar').classList.toggle('hidden', !(user.admin || user.canImport));
                aplicarPermissoes(user);
                mostrarNotificacao(`Bem-vindo, ${escapeHTML(user.nome)}!`, 'sucesso');
                resetAll(); // Clear form on login
            } else {
                mostrarNotificacao('Usuário ou senha inválidos', 'erro');
                document.getElementById('passInput').value = '';
                document.getElementById('passInput').focus();
            }
        } catch (error) {
             console.error("Erro no login:", error);
             mostrarNotificacao('Erro ao tentar fazer login. Verifique a conexão.', 'erro');
        } finally {
            btnLogin.disabled = false;
            btnLogin.textContent = 'Entrar';
        }
    };

    function aplicarPermissoes(user) {
        const isReadOnly = user.readOnly || false;
        window.canDelete = user.admin || user.canDelete || false; // Set global flag

        const formElements = document.querySelectorAll('#associadoForm input, #associadoForm select, #associadoForm textarea');
        formElements.forEach(el => el.disabled = isReadOnly);

        document.getElementById('btnAlterar').disabled = false; // Procurar sempre habilitado
        document.getElementById('btnGravar').disabled = isReadOnly;
        document.getElementById('btnNovo').disabled = isReadOnly;
        document.getElementById('btnAddDependente').disabled = isReadOnly;

        // Ensure dependent remove buttons respect read-only
        // (This will be handled dynamically in renderDeps)
        renderDeps(); // Re-render deps to apply disabled state if needed
    }

    window.doLogout = function() {
        if (confirm('Deseja realmente sair?')) {
            window.usuarioLogado = null;
            window.associadosList = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('userInput').value = '';
            document.getElementById('passInput').value = '';
            document.getElementById('btnGerencia').classList.add('hidden');
            document.getElementById('btnResumoGeral').classList.add('hidden');
            document.getElementById('btnImportar').classList.add('hidden');
            mostrarNotificacao('Você saiu do sistema', 'info');
        }
    };

    window.abrirPesquisa = async function() {
        document.getElementById('modalPesquisa').classList.add('active');
        document.getElementById('searchModalInput').value = '';
        try {
            mostrarNotificacao('Carregando cooperados...', 'info');
            window.associadosList = await getData(); // Cache data
            filtrarModal(); // Display all initially or based on empty term
            mostrarNotificacao('Lista carregada.', 'sucesso');
        } catch (error) {
             mostrarNotificacao('Erro ao carregar lista.', 'erro');
        } finally {
             document.getElementById('searchModalInput').focus();
        }
    };

    window.fecharPesquisa = function() {
        document.getElementById('modalPesquisa').classList.remove('active');
        window.associadosList = null; // Clear cache
    };

    window.novo = function() {
        if (window.usuarioLogado.readOnly) return;
        resetAll();
        switchTab('dados');
        document.getElementById('nome').focus();
        mostrarNotificacao('Novo registro pronto para preenchimento.', 'info');
    };

    window.gravar = async function() {
        // Prevent default form submission if called from button
        await saveAll(new Event('submit', { cancelable: true }));
    };

    window.alterar = function() {
        // "Alterar" button now just opens the search modal
        abrirPesquisa();
    };

    window.imprimirPDF = async function() {
        await buildResumo(); // Ensure resumo content is up-to-date
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const contentElement = document.getElementById('resumoContent');
        const nomeTitular = document.getElementById('nome').value || 'Cooperado';

        if (!document.getElementById('editIndex').value) {
            mostrarNotificacao('Nenhum cooperado selecionado para gerar PDF.', 'aviso');
            return;
        }

        doc.setFontSize(16);
        doc.text('CBSaúde Cooperados - Resumo Individual', 14, 22);

        // Use html method for better formatting (requires html2canvas implicitly via jsPDF)
        try {
            await doc.html(contentElement, {
                callback: function (doc) {
                    doc.save(`Resumo-${nomeTitular}.pdf`);
                    mostrarNotificacao('PDF gerado com sucesso!', 'sucesso');
                },
                x: 10,
                y: 30, // Start content lower
                width: 190, // A4 width in mm minus margins
                windowWidth: contentElement.scrollWidth // Use element width for rendering
            });
        } catch (error) {
             console.error("Erro ao gerar PDF:", error);
             mostrarNotificacao('Erro ao gerar PDF.', 'erro');
             // Fallback to basic text rendering if html fails
             const conteudo = contentElement.innerText;
             doc.setFontSize(12);
             const linhas = conteudo.split('\n').filter(l => l.trim());
             let y = 40;
             linhas.forEach((linha) => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                // Split long lines manually if needed (jsPDF text handles some wrapping)
                const splitLines = doc.splitTextToSize(linha, 180);
                doc.text(splitLines, 14, y);
                y += (splitLines.length * 6);
            });
            doc.save(`Resumo-${nomeTitular}-texto.pdf`);
             mostrarNotificacao('PDF (texto simples) gerado.', 'aviso');
        }
    };

    window.switchTab = async function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tabContent').forEach(c => c.classList.remove('active'));
        const tabElement = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
        const contentElement = document.getElementById(tab);
        if (tabElement) tabElement.classList.add('active');
        if (contentElement) contentElement.classList.add('active');

        if (tab === 'resumo') await buildResumo();
        if (tab === 'dependentes') renderDeps(); // Ensure deps are rendered
    };

    window.abrirGerenciaFuncionarios = async function() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado. Apenas administradores.', 'erro');
            return;
        }
        document.getElementById('modalFuncionarios').classList.add('active');
        resetFuncForm(); // Clear form when opening
        await renderizarFuncionarios();
    };

    window.fecharGerenciaFuncionarios = function() {
        document.getElementById('modalFuncionarios').classList.remove('active');
    };

    window.adicionarOuAtualizarFuncionario = async function() {
         if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        const nome = document.getElementById('funcNome').value.trim();
        const user = document.getElementById('funcUser').value.trim();
        const pass = document.getElementById('funcPass').value.trim();
        const admin = document.getElementById('funcAdmin').checked;
        const readOnly = document.getElementById('funcReadOnly').checked;
        const canImport = document.getElementById('funcCanImport').checked;
        const canDelete = document.getElementById('funcCanDelete').checked;
        const editId = document.getElementById('funcEditId').value;

        if (!nome || !user || !pass) {
            mostrarNotificacao('Preencha Nome, Usuário e Senha.', 'erro');
            return;
        }

        const funcData = { nome, user, pass, admin, readOnly, canImport, canDelete };

        try {
            if (editId) {
                // Check if username is being changed to one that already exists (excluding itself)
                const funcs = await getFuncionarios();
                if (funcs.some(f => f.user === user && f.id !== editId)) {
                    mostrarNotificacao('Usuário já existe.', 'erro');
                    return;
                }
                await updateDoc(doc(db, 'funcionarios', editId), funcData);
                mostrarNotificacao('Funcionário atualizado!', 'sucesso');
            } else {
                 // Check if username already exists
                const funcs = await getFuncionarios();
                if (funcs.some(f => f.user === user)) {
                    mostrarNotificacao('Usuário já existe.', 'erro');
                    return;
                }
                await addDoc(collection(db, 'funcionarios'), funcData);
                mostrarNotificacao('Funcionário adicionado!', 'sucesso');
            }
            resetFuncForm();
            await renderizarFuncionarios();
        } catch(error) {
            console.error("Erro ao salvar funcionário:", error);
            mostrarNotificacao('Erro ao salvar funcionário.', 'erro');
        }
    };

    window.editarFuncionario = async function(id) {
        if (!window.usuarioLogado?.admin) return;
        try {
            const docSnap = await getDoc(doc(db, 'funcionarios', id));
            if (docSnap.exists()) {
                const f = docSnap.data();
                document.getElementById('funcEditId').value = id; // Store ID for update
                document.getElementById('funcNome').value = f.nome;
                document.getElementById('funcUser').value = f.user;
                document.getElementById('funcPass').value = f.pass; // Consider masking or prompting
                document.getElementById('funcAdmin').checked = f.admin || false;
                document.getElementById('funcReadOnly').checked = f.readOnly || false;
                document.getElementById('funcCanImport').checked = f.canImport || false;
                document.getElementById('funcCanDelete').checked = f.canDelete || false;
                document.getElementById('btnSalvarFunc').textContent = 'Atualizar';
            }
        } catch (error) {
            console.error("Erro ao carregar funcionário para edição:", error);
            mostrarNotificacao('Erro ao carregar dados do funcionário.', 'erro');
        }
    };

    window.resetFuncForm = function() { // Made global for Cancel button
        document.getElementById('funcEditId').value = '';
        document.getElementById('funcNome').value = '';
        document.getElementById('funcUser').value = '';
        document.getElementById('funcPass').value = '';
        document.getElementById('funcAdmin').checked = false;
        document.getElementById('funcReadOnly').checked = false;
        document.getElementById('funcCanImport').checked = false;
        document.getElementById('funcCanDelete').checked = false;
        document.getElementById('btnSalvarFunc').textContent = 'Adicionar';
    }

    async function renderizarFuncionarios() {
        const funcs = await getFuncionarios();
        const div = document.getElementById('listaFuncionarios');
        div.innerHTML = ''; // Clear previous list
        funcs.forEach(f => {
            const roles = [];
            if (f.admin) roles.push('Admin');
            if (f.readOnly) roles.push('Leitura');
            if (f.canImport) roles.push('Importar');
            if (f.canDelete) roles.push('Excluir');
            const rolesText = roles.length ? ` (${roles.join(', ')})` : '';

            const editBtn = `<button class="btn-top btn-small" style="background: var(--aviso);" onclick="editarFuncionario('${f.id}')">Editar</button>`;
            // Prevent deleting the main admin or self
            const removeBtn = (f.user === 'admin' || f.user === window.usuarioLogado.user) ? '' : `<button class="btn-top btn-danger btn-small" onclick="removerFuncionario('${f.id}')">Remover</button>`;

            div.insertAdjacentHTML('beforeend', `
                <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                    <span style="flex-basis: 60%;">${escapeHTML(f.nome)} (${escapeHTML(f.user)})${rolesText}</span>
                    <div style="flex-shrink: 0;">${editBtn} ${removeBtn}</div>
                </div>
            `);
        });
        if (!funcs.length) div.innerHTML = '<p>Nenhum funcionário cadastrado.</p>';
    }

    window.removerFuncionario = async function(id) {
        if (!window.usuarioLogado?.admin) return;
        const docSnap = await getDoc(doc(db, 'funcionarios', id));
        if (docSnap.exists() && docSnap.data().user === 'admin') {
             mostrarNotificacao('Não é possível remover o usuário administrador principal.', 'erro');
             return;
        }
         if (docSnap.exists() && docSnap.data().user === window.usuarioLogado.user) {
             mostrarNotificacao('Você não pode remover a si mesmo.', 'erro');
             return;
        }

        if (!confirm('Remover este funcionário permanentemente?')) return;
        try {
            await deleteDoc(doc(db, 'funcionarios', id));
            await renderizarFuncionarios();
            mostrarNotificacao('Funcionário removido', 'sucesso');
        } catch (error) {
             console.error("Erro ao remover funcionário:", error);
             mostrarNotificacao('Erro ao remover funcionário.', 'erro');
        }
    };

    async function filtrarModal() {
        const term = removerAcentos(document.getElementById('searchModalInput').value.toLowerCase());
        const termDigits = term.replace(/\D/g, ''); // For CPF search
        const lista = window.associadosList; // Use cached list

        if (!lista) {
            document.getElementById('modalResults').innerHTML = '<p>Carregando dados...</p>';
            return; // Don't filter if list isn't ready
        }

        const div = document.getElementById('modalResults');
        div.innerHTML = ''; // Clear previous results

        const filtered = lista.filter(a => {
            const nomeNorm = removerAcentos((a.nome || '').toLowerCase());
            const cpfDigits = cleanCPF(a.cpf); // Get only digits from stored CPF
            return nomeNorm.includes(term) || (termDigits && cpfDigits.includes(termDigits));
        });

        filtered.forEach(a => {
            // Check permission before rendering remove button
            const removeBtn = window.canDelete ? `<button class="btn-top btn-danger btn-small" onclick="removerCooperado('${a.id}', event)">Remover</button>` : '';

            div.insertAdjacentHTML('beforeend', `
                <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
                    <div onclick="editAssociado('${a.id}')" style="flex:1;cursor:pointer; padding-right: 10px;">
                        <span>${escapeHTML(a.nome)}</span>
                        <small>CPF: ${formatarCPF(a.cpf) || '—'} | Pasta: ${a.pasta || '—'}</small>
                    </div>
                    ${removeBtn}
                </div>
            `);
        });
        if (!filtered.length) div.innerHTML = '<p>Nenhum resultado encontrado.</p>';
    }

    window.debouncedFilter = debounce(filtrarModal, 350); // Slightly longer debounce

    window.handleSearchEnter = function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent potential form submission if inside one
            filtrarModal(); // Trigger filter immediately on Enter
        }
    };

    window.removerCooperado = async function(id, event) {
        event.stopPropagation(); // Prevent triggering editAssociado
        if (!window.canDelete) {
            mostrarNotificacao('Acesso negado. Você não pode excluir.', 'erro');
            return;
        }
        if (!confirm('ATENÇÃO: Remover este cooperado permanentemente? Esta ação não pode ser desfeita.')) return;

        const listItem = event.target.closest('.list-item');
        if (listItem) listItem.style.opacity = '0.5'; // Visual feedback

        try {
            await deleteDoc(doc(db, 'associados', id));
            // Remove from cached list immediately for responsiveness
            if (window.associadosList) {
                window.associadosList = window.associadosList.filter(a => a.id !== id);
            }
            if (listItem) listItem.remove(); // Remove element directly
            mostrarNotificacao('Cooperado removido com sucesso!', 'sucesso');
            // Optional: Re-filter if needed, though removing the element might suffice
            // filtrarModal();
        } catch (error) {
            console.error("Erro ao remover cooperado:", error);
            mostrarNotificacao('Erro ao remover cooperado.', 'erro');
            if (listItem) listItem.style.opacity = '1'; // Restore opacity on error
        }
    };

    window.addDependente = function() {
        if (window.usuarioLogado.readOnly) return;
        // Add empty dependent object
        window.deps.push({ nome: '', parent: '', nasc: '', cpf: '', plano: '' });
        renderDeps(); // Re-render the list
        // Focus the name field of the newly added dependent
        const depInputs = document.querySelectorAll('#depsList .row:last-child input');
        if (depInputs.length > 0) {
            depInputs[0].focus();
        }
    };

    window.removeDependente = function(index) {
        if (window.usuarioLogado.readOnly) return;
        window.deps.splice(index, 1);
        renderDeps();
    }

    window.renderDeps = function() {
        const div = document.getElementById('depsList');
        div.innerHTML = ''; // Clear previous list
        const isReadOnly = window.usuarioLogado?.readOnly || false;
        const removeButtonHTML = isReadOnly ? '' : `<button type="button" class="btn-top btn-danger btn-small" onclick="removeDependente({index})">Remover</button>`;

        window.deps.forEach((d, i) => {
            const uniqueIdPrefix = `dep-${i}-`;
            div.insertAdjacentHTML('beforeend', `
                <div class="row animate-scale-in" style="align-items: end; margin-bottom: 1rem; padding: 1rem; background: var(--azul-claro); border-radius: 8px;">
                    <div class="col"><label for="${uniqueIdPrefix}nome">Nome</label><input id="${uniqueIdPrefix}nome" value="${escapeHTML(d.nome)}" onchange="window.deps[${i}].nome=this.value.trim()" ${isReadOnly ? 'disabled' : ''}></div>
                    <div class="col"><label for="${uniqueIdPrefix}parent">Parentesco</label><input id="${uniqueIdPrefix}parent" value="${escapeHTML(d.parent)}" onchange="window.deps[${i}].parent=this.value.trim()" ${isReadOnly ? 'disabled' : ''}></div>
                    <div class="col"><label for="${uniqueIdPrefix}nasc">Nasc.</label><input id="${uniqueIdPrefix}nasc" type="date" value="${formatToISODate(d.nasc)}" onchange="window.deps[${i}].nasc=formatToDisplayDate(this.value)" ${isReadOnly ? 'disabled' : ''}></div>
                    <div class="col"><label for="${uniqueIdPrefix}cpf">CPF</label><input id="${uniqueIdPrefix}cpf" value="${formatarCPF(d.cpf)}" onblur="this.value=formatarCPF(this.value)" onchange="window.deps[${i}].cpf=cleanCPF(this.value)" ${isReadOnly ? 'disabled' : ''}></div>
                    <div class="col"><label for="${uniqueIdPrefix}plano">Plano</label>
                        <select id="${uniqueIdPrefix}plano" onchange="window.deps[${i}].plano=this.value" ${isReadOnly ? 'disabled' : ''}>
                            <option value="">Nenhum</option>
                            <option value="224" ${d.plano==='224'?'selected':''}>Alfa (224)</option>
                            <option value="226" ${d.plano==='226'?'selected':''}>Bravo (226)</option>
                            <option value="228" ${d.plano==='228'?'selected':''}>Delta (228)</option>
                        </select>
                    </div>
                    <div class="col" style="flex-grow: 0;"> ${removeButtonHTML.replace('{index}', i)} </div>
                </div>
            `);
             // Add CPF validation feedback on blur for dependents
            const cpfInput = document.getElementById(`${uniqueIdPrefix}cpf`);
            if (cpfInput) {
                cpfInput.addEventListener('blur', function() {
                    const cleanedCpf = cleanCPF(this.value);
                    if (cleanedCpf && !validarCPF(cleanedCpf)) {
                        mostrarNotificacao(`CPF inválido para ${escapeHTML(window.deps[i].nome || `Dependente ${i+1}`)}`, 'erro');
                        this.focus();
                    }
                });
            }
        });
        if (!window.deps.length) {
             div.innerHTML = '<p>Nenhum dependente adicionado.</p>';
        }
    };


    async function buildResumo() {
        const r = document.getElementById('resumoContent');
        r.innerHTML = ''; // Clear previous

        // Use current form data for live preview, fallback to saved data if needed
        const currentData = {
            nome: document.getElementById('nome').value || '—',
            cpf: formatarCPF(document.getElementById('cpf').value) || '—',
            plano: document.getElementById('plano').value,
            dataAssociacao: formatToDisplayDate(document.getElementById('dataAssociacao').value),
            dependentes: window.deps || [],
            conjuge: {
                nome: document.getElementById('conjNome').value || '',
                cpf: formatarCPF(document.getElementById('conjCpf').value) || '—',
                nasc: formatToDisplayDate(document.getElementById('conjNasc').value) || '—',
                plano: document.getElementById('conjPlano').value
            },
             obs: document.getElementById('obs').value || ''
        };

        const planoTit = currentData.plano;
        const valorTit = valorPlano(planoTit);
        r.insertAdjacentHTML('beforeend', `
            <div class="resumo-block">
                <h3>Titular</h3>
                <div class="resumo-line"><span>Nome:</span><span>${escapeHTML(currentData.nome)}</span></div>
                <div class="resumo-line"><span>CPF:</span><span>${currentData.cpf}</span></div>
                <div class="resumo-line"><span>Plano:</span><span>${nomePlano(planoTit)} (${planoTit || '—'}) - R$ ${valorTit.toFixed(2)}</span></div>
            </div>
        `);

        let total = valorTit;
        if (currentData.dependentes && currentData.dependentes.length > 0) {
            r.insertAdjacentHTML('beforeend', '<h3>Dependentes</h3>');
            currentData.dependentes.forEach(d => {
                 if (!d.nome) return; // Skip empty dependents
                const v = valorPlano(d.plano);
                total += v;
                r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-line">
                        <span>${escapeHTML(d.nome)} (${escapeHTML(d.parent || '—')}) - CPF: ${formatarCPF(d.cpf) || '—'} - Plano: ${nomePlano(d.plano)} (${d.plano || '—'})</span>
                        <span>R$ ${v.toFixed(2)}</span>
                    </div>
                `);
            });
        }

        const conj = currentData.conjuge;
        if (conj.nome) {
            const conjValor = valorPlano(conj.plano);
            r.insertAdjacentHTML('beforeend', '<h3>Cônjuge</h3>');
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-line">
                    <span>${escapeHTML(conj.nome)} - CPF: ${conj.cpf} - Nasc: ${conj.nasc} - Plano: ${nomePlano(conj.plano)} (${conj.plano || '—'})</span>
                    <span>R$ ${conjValor.toFixed(2)}</span>
                </div>
            `);
            total += conjValor;
        }

        let months = 0;
        let totalPaid = 0;
        if (currentData.dataAssociacao) {
             const assocDateStr = formatToISODate(currentData.dataAssociacao); // Convert to ISO if needed
             if (assocDateStr) {
                 const joinDate = new Date(assocDateStr + 'T00:00:00'); // Ensure it's treated as local date
                 const now = new Date();
                 // Correct month calculation
                 months = (now.getFullYear() - joinDate.getFullYear()) * 12 + (now.getMonth() - joinDate.getMonth());
                 if (now.getDate() < joinDate.getDate()) {
                     months--;
                 }
                 months = Math.max(months, 0); // Ensure non-negative
                 totalPaid = months * total;
                 r.insertAdjacentHTML('beforeend', `
                    <div class="resumo-block">
                        <h3>Histórico</h3>
                        <div class="resumo-line"><span>Data de Associação:</span><span>${currentData.dataAssociacao}</span></div>
                        <div class="resumo-line"><span>Meses Cooperado:</span><span>${months}</span></div>
                        <div class="resumo-line"><span>Total Pago (estimado):</span><span>R$ ${totalPaid.toFixed(2)}</span></div>
                    </div>
                `);
             } else {
                  r.insertAdjacentHTML('beforeend', `<div class="resumo-block"><h3>Histórico</h3><p>Data de Associação inválida.</p></div>`);
             }
        } else {
            r.insertAdjacentHTML('beforeend', `<div class="resumo-block"><h3>Histórico</h3><p>Data de Associação não informada.</p></div>`);
        }

        let pend = [];
        if (!cleanCPF(currentData.cpf)) pend.push('CPF do titular faltando ou inválido');
        if (!currentData.nasc) pend.push('Data de nascimento do titular faltando');
        currentData.dependentes?.forEach((d, i) => {
            if (d.nome) { // Only check non-empty dependents
                const cleanedDepCpf = cleanCPF(d.cpf);
                if (!cleanedDepCpf || !validarCPF(cleanedDepCpf)) pend.push(`CPF do dependente ${i+1} (${escapeHTML(d.nome)}) faltando ou inválido`);
                if (!d.nasc) pend.push(`Data de nascimento do dependente ${i+1} (${escapeHTML(d.nome)}) faltando`);
            }
        });
        if (conj.nome) {
            const cleanedConjCpf = cleanCPF(conj.cpf);
            if (!cleanedConjCpf || !validarCPF(cleanedConjCpf)) pend.push('CPF do cônjuge faltando ou inválido');
            if (!conj.nasc) pend.push('Data de nascimento do cônjuge faltando');
        }
        if (pend.length > 0) {
            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block" style="border-color: var(--aviso);">
                    <h3 style="color: var(--aviso);">Pendências</h3>
                    <ul style="color: var(--aviso);">${pend.map(p => `<li>${p}</li>`).join('')}</ul>
                </div>
            `);
        }

        if(currentData.obs) {
             r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Observações</h3>
                    <p>${escapeHTML(currentData.obs)}</p>
                </div>
            `);
        }

        r.insertAdjacentHTML('beforeend', `
            <div class="total">Total Mensal Atual: R$ ${total.toFixed(2)}</div>
        `);
    }

    window.abrirResumoGeral = async function() {
        if (!window.usuarioLogado?.admin) {
            mostrarNotificacao('Acesso negado. Apenas administradores.', 'erro');
            return;
        }
        document.getElementById('modalResumoGeral').classList.add('active');
        document.getElementById('resumoGeralContent').innerHTML = '<p>Calculando resumo...</p>'; // Loading state
        await buildResumoGeral();
    };

    window.fecharResumoGeral = function() {
        document.getElementById('modalResumoGeral').classList.remove('active');
    };

    async function buildResumoGeral() {
        const r = document.getElementById('resumoGeralContent');
        r.innerHTML = '<h2>Resumo Geral - CBSaúde Cooperados</h2>'; // Reset content

        try {
            const lista = await getData(); // Fetch fresh data
            let totalGeralMensal = 0;
            let countCooperados = 0;
            let countDependentes = 0;
            let countConjuges = 0;
            const planoCounts = { '224': 0, '226': 0, '228': 0, 'total': 0 };

            for (const a of lista) {
                if (!a.nome) continue; // Skip potentially empty records

                countCooperados++;
                let totalIndividual = valorPlano(a.plano);
                if (a.plano) {
                     planoCounts[a.plano]++;
                     planoCounts['total']++;
                }

                (a.dependentes || []).forEach(d => {
                     if (d.nome) { // Only count dependents with names
                         countDependentes++;
                         totalIndividual += valorPlano(d.plano);
                         if (d.plano) {
                              planoCounts[d.plano]++;
                              planoCounts['total']++;
                         }
                     }
                });

                if (a.conjuge?.nome) {
                    countConjuges++;
                    totalIndividual += valorPlano(a.conjuge.plano);
                    if (a.conjuge.plano) {
                         planoCounts[a.conjuge.plano]++;
                         planoCounts['total']++;
                    }
                }
                totalGeralMensal += totalIndividual;
            }

            r.insertAdjacentHTML('beforeend', `
                <div class="resumo-block">
                    <h3>Estatísticas Gerais</h3>
                    <div class="resumo-line"><span>Total de Cooperados Titulares:</span><span>${countCooperados}</span></div>
                    <div class="resumo-line"><span>Total de Dependentes:</span><span>${countDependentes}</span></div>
                    <div class="resumo-line"><span>Total de Cônjuges:</span><span>${countConjuges}</span></div>
                    <div class="resumo-line"><span>Total de Vidas Cobertas:</span><span>${countCooperados + countDependentes + countConjuges}</span></div>
                    <hr>
                    <div class="resumo-line"><span>Planos Alfa (224):</span><span>${planoCounts['224']}</span></div>
                    <div class="resumo-line"><span>Planos Bravo (226):</span><span>${planoCounts['226']}</span></div>
                    <div class="resumo-line"><span>Planos Delta (228):</span><span>${planoCounts['228']}</span></div>
                    <div class="resumo-line"><span>Total de Planos Ativos:</span><span>${planoCounts['total']}</span></div>
                    <hr>
                    <div class="total">Faturamento Mensal Estimado: R$ ${totalGeralMensal.toFixed(2)}</div>
                </div>
            `);
        } catch (error) {
             r.innerHTML = '<p style="color: red;">Erro ao gerar resumo geral.</p>';
             console.error("Erro no resumo geral:", error);
        }
    }


    function resetAll() {
        document.getElementById('associadoForm').reset();
        document.getElementById('editIndex').value = ''; // Clear edit ID
        window.deps = []; // Clear dependents array
        renderDeps(); // Clear dependents UI
        switchTab('dados'); // Go back to the first tab
    }

    window.editAssociado = async function(id) {
        resetAll(); // Clear form before loading new data
        try {
            const docRef = doc(db, 'associados', id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const a = docSnap.data();
                document.getElementById('editIndex').value = id; // Set the ID for future saves

                // Populate main fields
                document.getElementById('nome').value = a.nome || '';
                document.getElementById('cpf').value = formatarCPF(a.cpf) || ''; // Format CPF for display
                document.getElementById('pasta').value = a.pasta || '';
                document.getElementById('matricula').value = a.matricula || '';
                document.getElementById('nasc').value = formatToISODate(a.nasc) || ''; // Format date for input
                document.getElementById('dataAssociacao').value = formatToISODate(a.dataAssociacao) || ''; // Format date for input
                document.getElementById('sexo').value = a.sexo || '';
                document.getElementById('civil').value = a.civil || '';
                document.getElementById('endereco').value = a.endereco || '';
                document.getElementById('numero').value = a.numero || '';
                document.getElementById('bairro').value = a.bairro || '';
                document.getElementById('municipio').value = a.municipio || '';
                document.getElementById('estado').value = a.estado || '';
                document.getElementById('cep').value = formatarCEP(a.cep) || ''; // Format CEP
                document.getElementById('telefone').value = formatarTelefone(a.telefone) || ''; // Format Phone
                document.getElementById('email').value = a.email || '';
                document.getElementById('plano').value = a.plano || '';
                document.getElementById('obs').value = a.obs || '';

                // Populate dependents
                window.deps = a.dependentes || [];
                renderDeps();

                // Populate spouse
                const conj = a.conjuge || {};
                document.getElementById('conjNome').value = conj.nome || '';
                document.getElementById('conjCpf').value = formatarCPF(conj.cpf) || ''; // Format CPF
                document.getElementById('conjNasc').value = formatToISODate(conj.nasc) || ''; // Format date
                document.getElementById('conjPlano').value = conj.plano || '';

                switchTab('dados'); // Go to the first tab
                fecharPesquisa(); // Close the search modal
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
                mostrarNotificacao('Cooperado carregado para edição.', 'info');
            } else {
                mostrarNotificacao('Cooperado não encontrado.', 'erro');
            }
        } catch (error) {
             console.error("Erro ao carregar associado:", error);
             mostrarNotificacao('Erro ao carregar dados do cooperado.', 'erro');
        }
    };


    window.saveAll = async function(event) {
        event.preventDefault(); // Prevent default form submission
        if (window.usuarioLogado.readOnly) {
            mostrarNotificacao('Operação não permitida. Você tem permissão somente de leitura.', 'erro');
            return;
        }

        const form = document.getElementById('associadoForm');
        const editId = document.getElementById('editIndex').value;

        // Collect and clean data
        const associado = {
            nome: form.nome.value.trim(),
            cpf: cleanCPF(form.cpf.value), // Store clean CPF
            pasta: form.pasta.value.trim(),
            matricula: form.matricula.value.trim(),
            nasc: formatToDisplayDate(form.nasc.value), // Store as dd/mm/yyyy or empty
            dataAssociacao: formatToDisplayDate(form.dataAssociacao.value), // Store as dd/mm/yyyy or empty
            sexo: form.sexo.value,
            civil: form.civil.value,
            endereco: form.endereco.value.trim(),
            numero: form.numero.value.trim(),
            bairro: form.bairro.value.trim(),
            municipio: form.municipio.value.trim(),
            estado: form.estado.value.trim().toUpperCase(),
            cep: cleanCPF(form.cep.value), // Store clean CEP
            telefone: cleanCPF(form.telefone.value), // Store clean phone
            email: form.email.value.trim().toLowerCase(),
            plano: form.plano.value,
            obs: form.obs.value.trim(),
            dependentes: window.deps.map(d => ({ // Ensure dependents also have clean CPFs
                nome: d.nome?.trim() || '',
                parent: d.parent?.trim() || '',
                nasc: formatToDisplayDate(d.nasc) || '', // Store as dd/mm/yyyy or empty
                cpf: cleanCPF(d.cpf) || '',
                plano: d.plano || ''
            })).filter(d => d.nome), // Only save dependents with a name
            conjuge: {
                nome: form.conjNome.value.trim(),
                cpf: cleanCPF(form.conjCpf.value), // Store clean CPF
                nasc: formatToDisplayDate(form.conjNasc.value), // Store as dd/mm/yyyy or empty
                plano: form.conjPlano.value
            }
        };

        // --- Validations ---
        if (!associado.nome || !associado.cpf) {
            mostrarNotificacao('Nome e CPF são obrigatórios para o titular.', 'erro');
            switchTab('dados'); // Switch to the relevant tab
            document.getElementById('nome').focus();
            return;
        }
        if (!validarCPF(associado.cpf)) {
            mostrarNotificacao('CPF do titular é inválido.', 'erro');
            switchTab('dados');
            document.getElementById('cpf').focus();
            return;
        }
        if (associado.conjuge.nome && associado.conjuge.cpf && !validarCPF(associado.conjuge.cpf)) {
            mostrarNotificacao('CPF do cônjuge é inválido.', 'erro');
             switchTab('conjuge');
             document.getElementById('conjCpf').focus();
            return;
        }
        for (let i = 0; i < associado.dependentes.length; i++) {
            const d = associado.dependentes[i];
            if (d.cpf && !validarCPF(d.cpf)) {
                mostrarNotificacao(`CPF do dependente ${i+1} (${escapeHTML(d.nome)}) é inválido.`, 'erro');
                switchTab('dependentes');
                // Try to focus the specific input
                const depCpfInput = document.getElementById(`dep-${i}-cpf`);
                if(depCpfInput) depCpfInput.focus();
                return;
            }
        }
        // --- End Validations ---

        const btnGravar = document.getElementById('btnGravar');
        btnGravar.disabled = true;
        btnGravar.textContent = 'Salvando...';

        try {
            if (editId) {
                // Update existing document
                await setDoc(doc(db, 'associados', editId), associado);
                mostrarNotificacao('Cooperado atualizado com sucesso!', 'sucesso');
            } else {
                // Add new document
                const docRef = await addDoc(collection(db, 'associados'), associado);
                document.getElementById('editIndex').value = docRef.id; // Set ID after creation
                mostrarNotificacao('Cooperado adicionado com sucesso!', 'sucesso');
            }
            // Optionally keep the form filled after saving, or call resetAll()
            // resetAll();
        } catch (error) {
            console.error('Erro ao salvar:', error);
            mostrarNotificacao('Erro ao salvar os dados. Verifique o console para detalhes.', 'erro');
        } finally {
             btnGravar.disabled = false;
             btnGravar.textContent = 'Gravar';
        }
    };


    window.abrirImportarDados = function() {
        if (!window.usuarioLogado?.admin && !window.usuarioLogado?.canImport) {
            mostrarNotificacao('Acesso negado. Você não pode importar dados.', 'erro');
            return;
        }
        document.getElementById('modalImportar').classList.add('active');
    };

    window.fecharImportarDados = function() {
        document.getElementById('modalImportar').classList.remove('active');
    };

    function cleanDateString(dn) {
        if (!dn || String(dn).includes('#') || String(dn).trim() === '') return ''; // Return empty string for invalid dates
        // Keep original format if it looks like dd/mm/yyyy
        if (String(dn).match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return String(dn).trim();
        }
        // If it's another format (like maybe ISO YYYY-MM-DD from somewhere else), return it too
         if (String(dn).match(/^\d{4}-\d{2}-\d{2}$/)) {
             return String(dn).trim();
         }
        // Otherwise, assume invalid or unknown format
        return '';
    }

    function mapPlano(planoStr) {
        if (!planoStr) return '';
        const upper = String(planoStr).toUpperCase().trim();
        if (upper.includes('ALFA')) return '224';
        if (upper.includes('BRAVO')) return '226';
        if (upper.includes('DELTA')) return '228';
        // Add handling for other potential values if needed, e.g. 'CHARLE' was seen
        // if (upper.includes('CHARLE')) return 'CODE_FOR_CHARLIE';
        return ''; // Default to empty if no recognized plan
    }


    window.importarDados = async function() {
        if (!window.usuarioLogado?.admin && !window.usuarioLogado?.canImport) {
            mostrarNotificacao('Acesso negado.', 'erro');
            return;
        }
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) {
            mostrarNotificacao('Selecione um arquivo JSON ou CSV.', 'erro');
            return;
        }

        const reader = new FileReader();
        const btnImportar = document.querySelector('#modalImportar button[onclick="importarDados()"]');
        btnImportar.disabled = true;
        btnImportar.textContent = 'Importando...';
        mostrarNotificacao('Iniciando importação...', 'info');

        reader.onload = async (e) => {
            const text = e.target.result;
            let data;
            let errors = [];
            let importedCount = 0;

            try {
                if (file.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(text);
                        if (!Array.isArray(data)) throw new Error("JSON não é um array.");
                    } catch (err) {
                        mostrarNotificacao(`Erro ao ler JSON: ${err.message}`, 'erro');
                        return;
                    }

                    let currentTitular = null;
                    const itemsToSave = []; // Batch saves

                    for (const item of data) {
                         // Skip rows that look like metadata or are empty
                         const nomeCooperado = item.COOPERADOS ? String(item.COOPERADOS).trim() : '';
                         if (!nomeCooperado || nomeCooperado.toUpperCase().includes('ATUALIZAÇÃO') || nomeCooperado.includes('########') || nomeCooperado === 'SEM CADASTRO') {
                             continue;
                         }

                        if (item.PASTA !== null && item.PASTA !== undefined && item.PASTA !== '') {
                            // If there was a previous titular, add it to the save list
                            if (currentTitular) {
                                // Basic validation before adding to save list
                                if (currentTitular.nome && currentTitular.cpf && validarCPF(currentTitular.cpf)) {
                                    itemsToSave.push(currentTitular);
                                } else {
                                    errors.push(`${currentTitular.nome || 'Titular sem nome'} (Pasta: ${currentTitular.pasta}) - CPF inválido ou ausente`);
                                }
                            }
                            // Start a new titular
                            currentTitular = {
                                pasta: String(item.PASTA).trim(),
                                matricula: item["MAT."] ? String(item["MAT."]).trim() : '',
                                nome: nomeCooperado,
                                cpf: cleanCPF(item.CPF),
                                nasc: cleanDateString(item.DN),
                                plano: mapPlano(item.PLANO),
                                dependentes: [],
                                conjuge: {},
                                // Add CT if present
                                ct: item.CT ? String(item.CT).trim() : '',
                                // Add Parentesco for titular if needed (e.g., 'INATIVO', 'ATIVA')
                                statusParentesco: item.PARENTESCO ? String(item.PARENTESCO).trim() : ''
                            };
                        } else if (currentTitular) {
                            // This is a dependent or spouse for the current titular
                            const parentesco = item.PARENTESCO ? String(item.PARENTESCO).toUpperCase().trim() : '';
                            const dependenteData = {
                                nome: nomeCooperado,
                                parent: item.PARENTESCO ? String(item.PARENTESCO).trim() : '', // Store original case too
                                cpf: cleanCPF(item.CPF),
                                nasc: cleanDateString(item.DN),
                                plano: mapPlano(item.PLANO)
                            };

                            // Basic validation for dependent/spouse name
                            if (!dependenteData.nome) continue;

                            if (parentesco === 'CONJUGE' || parentesco === 'CONJUGÊ') { // Handle typo
                                currentTitular.conjuge = dependenteData;
                            } else if (parentesco) { // Any other non-empty parentesco is treated as dependent
                                currentTitular.dependentes.push(dependenteData);
                            } else {
                                // If parentesco is empty but it's not a titular row, maybe log or ignore?
                                console.warn("Registro sem PASTA e sem PARENTESCO:", item);
                            }
                        }
                    }

                    // Add the very last titular to the save list
                    if (currentTitular) {
                         if (currentTitular.nome && currentTitular.cpf && validarCPF(currentTitular.cpf)) {
                             itemsToSave.push(currentTitular);
                         } else {
                            errors.push(`${currentTitular.nome || 'Titular sem nome'} (Pasta: ${currentTitular.pasta}) - CPF inválido ou ausente`);
                         }
                    }

                     // Save all collected items
                     for (const titular of itemsToSave) {
                        try {
                             await addDoc(collection(db, 'associados'), titular);
                             importedCount++;
                        } catch (saveError) {
                             errors.push(`${titular.nome} - Erro ao salvar: ${saveError.message}`);
                        }
                    }

                } else if (file.name.endsWith('.csv')) {
                    // Basic CSV parsing (assuming comma delimiter and no quoted fields containing commas)
                    const lines = text.split(/\r?\n/);
                    if (lines.length < 2) {
                        mostrarNotificacao('CSV vazio ou sem dados.', 'erro');
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim());
                    // Find indices dynamically (more robust than fixed positions)
                    const indices = {
                        nome: headers.indexOf('COOPERADOS'),
                        cpf: headers.indexOf('CPF'),
                        pasta: headers.indexOf('PASTA'),
                        matricula: headers.indexOf('MAT.'),
                        nasc: headers.indexOf('DN'),
                        plano: headers.indexOf('PLANO'),
                        parentesco: headers.indexOf('PARENTESCO'),
                        ct: headers.indexOf('CT')
                        // Add other fields if needed for CSV import
                    };

                    let currentTitular = null;
                    const itemsToSave = [];

                    for (let i = 1; i < lines.length; i++) {
                         const line = lines[i].trim();
                         if (!line) continue;
                         const fields = line.split(',');

                         const nomeCooperado = fields[indices.nome] ? fields[indices.nome].trim() : '';
                          if (!nomeCooperado || nomeCooperado.toUpperCase().includes('ATUALIZAÇÃO') || nomeCooperado.includes('########') || nomeCooperado === 'SEM CADASTRO') {
                             continue;
                         }

                         const pastaValue = fields[indices.pasta] ? fields[indices.pasta].trim() : '';

                         if (pastaValue) { // Assuming non-empty PASTA means Titular in CSV too
                              if (currentTitular) {
                                   if (currentTitular.nome && currentTitular.cpf && validarCPF(currentTitular.cpf)) {
                                       itemsToSave.push(currentTitular);
                                   } else {
                                        errors.push(`${currentTitular.nome || 'Titular sem nome'} (Pasta: ${currentTitular.pasta}) - CPF inválido ou ausente`);
                                   }
                              }
                             currentTitular = {
                                pasta: pastaValue,
                                matricula: fields[indices.matricula] ? fields[indices.matricula].trim() : '',
                                nome: nomeCooperado,
                                cpf: cleanCPF(fields[indices.cpf]),
                                nasc: cleanDateString(fields[indices.nasc]),
                                plano: mapPlano(fields[indices.plano]),
                                dependentes: [],
                                conjuge: {},
                                ct: fields[indices.ct] ? fields[indices.ct].trim() : '',
                                statusParentesco: fields[indices.parentesco] ? fields[indices.parentesco].trim() : ''
                            };
                         } else if (currentTitular) {
                             const parentesco = fields[indices.parentesco] ? fields[indices.parentesco].toUpperCase().trim() : '';
                             const dependenteData = {
                                nome: nomeCooperado,
                                parent: fields[indices.parentesco] ? fields[indices.parentesco].trim() : '',
                                cpf: cleanCPF(fields[indices.cpf]),
                                nasc: cleanDateString(fields[indices.nasc]),
                                plano: mapPlano(fields[indices.plano])
                             };
                              if (!dependenteData.nome) continue;

                             if (parentesco === 'CONJUGE' || parentesco === 'CONJUGÊ') {
                                currentTitular.conjuge = dependenteData;
                             } else if (parentesco) {
                                currentTitular.dependentes.push(dependenteData);
                             } else {
                                  console.warn("Linha CSV sem PASTA e sem PARENTESCO:", fields);
                             }
                         }
                    }
                     // Save last titular
                    if (currentTitular) {
                         if (currentTitular.nome && currentTitular.cpf && validarCPF(currentTitular.cpf)) {
                             itemsToSave.push(currentTitular);
                         } else {
                            errors.push(`${currentTitular.nome || 'Titular sem nome'} (Pasta: ${currentTitular.pasta}) - CPF inválido ou ausente`);
                         }
                    }
                     // Save all collected items
                     for (const titular of itemsToSave) {
                        try {
                             await addDoc(collection(db, 'associados'), titular);
                             importedCount++;
                        } catch (saveError) {
                             errors.push(`${titular.nome} - Erro ao salvar: ${saveError.message}`);
                        }
                    }
                } else {
                    mostrarNotificacao('Formato de arquivo não suportado. Use .json ou .csv.', 'erro');
                    return; // Exit here
                }

                // Final notification
                if (errors.length > 0) {
                    mostrarNotificacao(`${importedCount} registros importados com ${errors.length} erros. Verifique o console para detalhes dos erros.`, 'aviso');
                    console.error("Erros na importação:", errors);
                } else if (importedCount > 0) {
                    mostrarNotificacao(`Importação concluída com sucesso! ${importedCount} titulares adicionados.`, 'sucesso');
                } else {
                     mostrarNotificacao('Nenhum registro válido encontrado para importar.', 'aviso');
                }

            } catch (error) { // Catch errors during the process
                console.error('Erro durante a importação:', error);
                mostrarNotificacao(`Erro durante a importação: ${error.message}`, 'erro');
            } finally {
                // Reset button and file input regardless of outcome
                btnImportar.disabled = false;
                btnImportar.textContent = 'Importar';
                fileInput.value = ''; // Clear file input
            }
        };

        reader.onerror = () => {
             mostrarNotificacao('Erro ao ler o arquivo.', 'erro');
             btnImportar.disabled = false;
             btnImportar.textContent = 'Importar';
        };

        reader.readAsText(file); // Start reading
    };


    // Initialize Admin User if not exists
    async function initAdmin() {
        try {
            const funcs = await getFuncionarios();
            if (!funcs.find(f => f.user === 'admin')) {
                await addDoc(collection(db, 'funcionarios'), {
                     nome: 'Administrador Principal',
                     user: 'admin',
                     pass: '1234', // Store passwords securely in a real app (e.g., hashed)
                     admin: true,
                     readOnly: false,
                     canImport: true,
                     canDelete: true
                 });
                console.log("Usuário admin inicializado.");
            }
        } catch (error) {
            console.error("Erro ao inicializar admin:", error);
            // Non-critical, login will fail if admin doesn't exist and DB is unreachable
        }
    }


    window.onload = async () => {
        await initAdmin(); // Ensure admin exists on load
        document.getElementById('userInput').focus(); // Focus user field on load

        // Add formatters and validators to inputs
        document.getElementById('cpf').addEventListener('blur', function() {
            const cleanedCpf = cleanCPF(this.value);
            this.value = formatarCPF(cleanedCpf); // Show formatted
            if (cleanedCpf && !validarCPF(cleanedCpf)) {
                mostrarNotificacao('CPF do titular é inválido!', 'erro');
                // Don't focus automatically, let user correct it.
            }
        });
        document.getElementById('telefone').addEventListener('blur', function() {
            this.value = formatarTelefone(this.value);
        });
        document.getElementById('cep').addEventListener('blur', function() {
            this.value = formatarCEP(this.value);
        });
        document.getElementById('conjCpf').addEventListener('blur', function() {
             const cleanedCpf = cleanCPF(this.value);
            this.value = formatarCPF(cleanedCpf);
            if (cleanedCpf && !validarCPF(cleanedCpf)) {
                mostrarNotificacao('CPF do cônjuge é inválido!', 'erro');
            }
        });

        // Login on Enter key press in password field
        document.getElementById('passInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doLogin();
            }
        });

        // Initialize dependents list on load
        renderDeps();
    };

</script>
</body>
</html>